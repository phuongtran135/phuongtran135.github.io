<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trình chỉnh sửa tệp Google Drive</title>
    <!-- Sử dụng Tailwind CSS để làm đẹp giao diện một cách nhanh chóng -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      /* Style cho thanh cuộn trong textarea */
      textarea::-webkit-scrollbar {
        width: 8px;
      }
      textarea::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }
      textarea::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
      }
      textarea::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <!-- Màn hình Cấu hình ban đầu -->
    <div
      id="setup_container"
      class="flex items-center justify-center min-h-screen"
    >
      <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8">
        <h1 class="text-2xl font-bold text-gray-800 text-center">
          Cấu hình kết nối Google Drive
        </h1>
        <p class="text-gray-500 text-center mt-2 mb-6">
          Vui lòng nhập thông tin từ Google Cloud Console.
        </p>
        <div class="space-y-4">
          <div>
            <label
              for="api_key_input"
              class="block text-sm font-medium text-gray-700"
              >API Key</label
            >
            <input
              type="password"
              id="api_key_input"
              class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Nhập API Key của bạn"
            />
          </div>
          <div>
            <label
              for="client_id_input"
              class="block text-sm font-medium text-gray-700"
              >Client ID</label
            >
            <input
              type="password"
              id="client_id_input"
              class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Nhập Client ID của bạn"
            />
          </div>
        </div>
        <button
          id="connect_button"
          class="mt-8 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105"
        >
          Kết nối
        </button>
        <p class="text-xs text-gray-400 mt-4 text-center">
          Thông tin này chỉ được sử dụng trong phiên làm việc hiện tại và không
          được lưu trữ.
        </p>
      </div>
    </div>

    <!-- Giao diện chính của ứng dụng (ẩn ban đầu) -->
    <div
      id="main_container"
      class="hidden flex items-center justify-center min-h-screen"
    >
      <div
        class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-10 transition-all duration-300"
      >
        <header
          class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 pb-4 border-b"
        >
          <div>
            <h1 class="text-3xl font-bold text-gray-800">
              Trình đọc/ghi tệp Google Drive
            </h1>
            <p class="text-gray-500 mt-1">
              Chỉnh sửa tệp văn bản trực tiếp từ Drive của bạn.
            </p>
          </div>
          <!-- Nút Đăng nhập/Đăng xuất -->
          <div id="auth-container" class="mt-4 sm:mt-0">
            <button
              id="authorize_button"
              class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105"
            >
              <svg
                class="inline-block w-5 h-5 mr-2"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 48 48"
                width="48px"
                height="48px"
              >
                <path
                  fill="#fbc02d"
                  d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12	s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20	s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"
                ></path>
                <path
                  fill="#e53935"
                  d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039	l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"
                ></path>
                <path
                  fill="#4caf50"
                  d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36	c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"
                ></path>
                <path
                  fill="#1565c0"
                  d="M43.611,20.083L43.595,20L42,20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574	l6.19,5.238C39.988,34.425,44,29.625,44,24C44,22.659,43.862,21.35,43.611,20.083z"
                ></path>
              </svg>
              Đăng nhập với Google
            </button>
            <button
              id="signout_button"
              class="hidden bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105"
            >
              Đăng xuất
            </button>
          </div>
        </header>
        <main id="content" class="hidden">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-1 bg-gray-50 p-4 rounded-lg border">
              <h2 class="text-xl font-semibold mb-3 text-gray-700">
                Tệp của bạn
              </h2>
              <div class="flex space-x-2 mb-3">
                <button
                  id="new_file_button"
                  class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded-md text-sm font-medium transition-colors"
                >
                  Tạo mới
                </button>
                <button
                  id="refresh_button"
                  class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 px-3 rounded-md text-sm font-medium transition-colors"
                >
                  Làm mới
                </button>
              </div>
              <select
                id="file_list"
                size="10"
                class="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              ></select>
            </div>
            <div class="md:col-span-2">
              <div class="flex justify-between items-center mb-3">
                <h2
                  id="current_file_name"
                  class="text-xl font-semibold text-gray-700"
                >
                  Chưa có tệp nào được chọn
                </h2>
                <button
                  id="save_button"
                  class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-5 rounded-lg shadow-sm transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled
                >
                  Lưu thay đổi
                </button>
              </div>
              <textarea
                id="file_content"
                class="w-full h-96 border border-gray-300 rounded-md p-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                placeholder="Chọn một tệp để xem nội dung hoặc tạo tệp mới..."
              ></textarea>
            </div>
          </div>
        </main>
        <footer class="mt-6 text-center text-sm text-gray-400">
          <p id="status"></p>
        </footer>
      </div>
    </div>

    <script type="text/javascript">
      // Các biến toàn cục sẽ được gán giá trị từ input của người dùng
      let API_KEY = "";
      let CLIENT_ID = "";

      const SCOPES = "https://www.googleapis.com/auth/drive.file";
      const DISCOVERY_DOCS = [
        "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
      ];

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;
      let currentFileId = null;

      // Lấy các phần tử DOM cho màn hình cấu hình
      const setupContainer = document.getElementById("setup_container");
      const mainContainer = document.getElementById("main_container");
      const apiKeyInput = document.getElementById("api_key_input");
      const clientIdInput = document.getElementById("client_id_input");
      const connectButton = document.getElementById("connect_button");

      // Lấy các phần tử DOM của ứng dụng chính
      const authorizeButton = document.getElementById("authorize_button");
      const signoutButton = document.getElementById("signout_button");
      const contentDiv = document.getElementById("content");
      const fileList = document.getElementById("file_list");
      const fileContent = document.getElementById("file_content");
      const saveButton = document.getElementById("save_button");
      const newFileButton = document.getElementById("new_file_button");
      const refreshButton = document.getElementById("refresh_button");
      const statusP = document.getElementById("status");
      const currentFileNameH2 = document.getElementById("current_file_name");

      // Gán sự kiện cho các nút
      connectButton.onclick = handleConnect;
      authorizeButton.onclick = handleAuthClick;
      signoutButton.onclick = handleSignoutClick;
      newFileButton.onclick = handleNewFile;
      refreshButton.onclick = listFiles;
      saveButton.onclick = handleSaveFile;
      fileList.onchange = handleFileSelect;

      fileContent.oninput = () => {
        saveButton.disabled = false;
      };

      /**
       * Xử lý khi người dùng nhập key và nhấn Kết nối.
       */
      function handleConnect() {
        const apiKeyVal = apiKeyInput.value.trim();
        const clientIdVal = clientIdInput.value.trim();

        if (!apiKeyVal || !clientIdVal) {
          alert("Vui lòng nhập cả API Key và Client ID.");
          return;
        }

        // Lưu trữ key vào biến toàn cục
        API_KEY = apiKeyVal;
        CLIENT_ID = clientIdVal;

        // Chuyển đổi giao diện
        setupContainer.classList.add("hidden");
        mainContainer.classList.remove("hidden");

        // Tải các script của Google sau khi đã có key
        loadGoogleScripts();
      }

      /**
       * Tải động các script của Google API.
       */
      function loadGoogleScripts() {
        // GIS script
        const gisScript = document.createElement("script");
        gisScript.src = "https://accounts.google.com/gsi/client";
        gisScript.async = true;
        gisScript.defer = true;
        gisScript.onload = () => gisLoaded();
        document.body.appendChild(gisScript);

        // GAPI script
        const gapiScript = document.createElement("script");
        gapiScript.src = "https://apis.google.com/js/api.js";
        gapiScript.async = true;
        gapiScript.defer = true;
        gapiScript.onload = () => gapiLoaded();
        document.body.appendChild(gapiScript);
      }

      /**
       * Được gọi khi thư viện GAPI client tải xong.
       */
      function gapiLoaded() {
        gapi.load("client", initializeGapiClient);
      }

      /**
       * Được gọi khi thư viện Google Identity Services (GIS) tải xong.
       */
      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: "", // Sẽ được định nghĩa lại khi gọi requestAccessToken
        });
        gisInited = true;
        maybeEnableButtons();
      }

      /**
       * Khởi tạo GAPI client.
       */
      async function initializeGapiClient() {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: DISCOVERY_DOCS,
        });
        gapiInited = true;
        maybeEnableButtons();
      }

      /**
       * Kích hoạt các nút nếu cả GAPI và GIS đã sẵn sàng.
       */
      function maybeEnableButtons() {
        if (gapiInited && gisInited) {
          authorizeButton.style.visibility = "visible";
        }
      }

      /**
       * Xử lý khi nhấn nút đăng nhập.
       */
      function handleAuthClick() {
        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            throw resp;
          }
          updateSigninStatus(true);
          signoutButton.innerText = `Đăng xuất`;
        };
        tokenClient.requestAccessToken({ prompt: "" });
      }

      /**
       * Xử lý khi nhấn nút đăng xuất.
       */
      function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken("");
          updateSigninStatus(false);
        }
      }

      /**
       * Cập nhật giao diện dựa trên trạng thái đăng nhập.
       */
      function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
          authorizeButton.classList.add("hidden");
          signoutButton.classList.remove("hidden");
          contentDiv.classList.remove("hidden");
          listFiles();
        } else {
          authorizeButton.classList.remove("hidden");
          signoutButton.classList.add("hidden");
          contentDiv.classList.add("hidden");
          fileList.innerHTML = "";
          fileContent.value = "";
          currentFileNameH2.innerText = "Chưa có tệp nào được chọn";
          currentFileId = null;
        }
      }

      /**
       * Liệt kê các tệp văn bản trong Drive của người dùng.
       */
      async function listFiles() {
        statusP.innerText = "Đang tải danh sách tệp...";
        fileList.innerHTML = "";
        try {
          const response = await gapi.client.drive.files.list({
            q: "mimeType='text/plain' and trashed=false",
            fields: "files(id, name)",
            spaces: "drive",
          });
          const files = response.result.files;
          if (files && files.length > 0) {
            files.forEach((file) => {
              const option = document.createElement("option");
              option.value = file.id;
              option.text = file.name;
              fileList.appendChild(option);
            });
            statusP.innerText = `Đã tìm thấy ${files.length} tệp.`;
          } else {
            statusP.innerText = "Không tìm thấy tệp văn bản nào.";
          }
        } catch (err) {
          console.error(err);
          statusP.innerText = `Lỗi: ${err.message}`;
        }
      }

      /**
       * Xử lý khi người dùng chọn một tệp từ danh sách.
       */
      async function handleFileSelect(event) {
        const fileId = event.target.value;
        if (!fileId) return;

        currentFileId = fileId;
        const selectedOption = fileList.options[fileList.selectedIndex];
        currentFileNameH2.innerText = `Đang chỉnh sửa: ${selectedOption.text}`;
        statusP.innerText = `Đang tải nội dung tệp...`;
        fileContent.value = "";
        saveButton.disabled = true;

        try {
          const response = await gapi.client.drive.files.get({
            fileId: fileId,
            alt: "media",
          });
          fileContent.value = response.body;
          statusP.innerText = "Tải nội dung thành công.";
        } catch (err) {
          console.error(err);
          statusP.innerText = `Lỗi khi tải tệp: ${err.result.error.message}`;
        }
      }

      /**
       * Xử lý khi nhấn nút "Tạo mới".
       */
      function handleNewFile() {
        currentFileId = null;
        fileContent.value = "";
        currentFileNameH2.innerText = "Soạn thảo tệp mới";
        fileList.selectedIndex = -1;
        fileContent.focus();
        saveButton.disabled = false;
        statusP.innerText = "Nhập nội dung cho tệp mới và nhấn Lưu.";
      }

      /**
       * Lưu tệp hiện tại (tạo mới hoặc cập nhật).
       */
      async function handleSaveFile() {
        saveButton.disabled = true;
        statusP.innerText = "Đang lưu...";
        const fileContentToSave = fileContent.value;

        if (currentFileId) {
          try {
            await gapi.client.request({
              path: `/upload/drive/v3/files/${currentFileId}`,
              method: "PATCH",
              params: { uploadType: "media" },
              body: fileContentToSave,
            });
            statusP.innerText = "Lưu thay đổi thành công!";
          } catch (err) {
            console.error(err);
            statusP.innerText = `Lỗi khi cập nhật tệp: ${err.result.error.message}`;
          }
        } else {
          const fileName = prompt(
            "Vui lòng nhập tên tệp (ví dụ: my-note.txt):",
            "untitled.txt"
          );
          if (!fileName) {
            statusP.innerText = "Hủy tạo tệp.";
            saveButton.disabled = false;
            return;
          }
          try {
            const fileMetadata = { name: fileName, mimeType: "text/plain" };
            const response = await gapi.client.drive.files.create({
              resource: fileMetadata,
              fields: "id",
            });
            const newFileId = response.result.id;
            await gapi.client.request({
              path: `/upload/drive/v3/files/${newFileId}`,
              method: "PATCH",
              params: { uploadType: "media" },
              body: fileContentToSave,
            });
            statusP.innerText = `Tạo và lưu tệp "${fileName}" thành công!`;
            currentFileId = newFileId;
            currentFileNameH2.innerText = `Đang chỉnh sửa: ${fileName}`;
            await listFiles();
          } catch (err) {
            console.error(err);
            statusP.innerText = `Lỗi khi tạo tệp: ${err.result.error.message}`;
          }
        }
        saveButton.disabled = false;
      }
    </script>
  </body>
</html>
