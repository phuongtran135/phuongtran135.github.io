<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trình Dịch Phụ Đề SRT với Gemini AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .custom-file-upload {
        border: 2px dashed #4a5568;
        transition: all 0.3s ease;
      }
      .custom-file-upload:hover,
      .custom-file-upload.dragover {
        border-color: #4c51bf;
        background-color: #2d3748;
      }
      #characterMapContainer .character-profile-card,
      #modal-content .character-profile-card {
        background-color: #2d3748;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid #4a5568;
      }
      #loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #4c51bf;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      #progress-bar-container {
        width: 100%;
        background-color: #4a5568;
        border-radius: 0.5rem;
        overflow: hidden;
        margin-top: 1rem;
      }
      #progress-bar {
        height: 10px;
        width: 0%;
        background-color: #4c51bf;
        transition: width 0.3s ease-in-out;
      }
      .modal-prose {
        line-height: 1.75;
      }
      .modal-prose p {
        margin-bottom: 1rem;
      }

      /* New styles for subtitle blocks */
      .sub-container {
        height: 60vh; /* Default height */
        overflow-y: auto;
        padding: 1rem;
        background-color: #1a202c; /* gray-900 */
        border-radius: 0.5rem;
        transition: height 0.3s ease-in-out;
      }
      .sub-container.expanded {
        height: 85vh; /* Expanded height */
      }
      .sub-container::-webkit-scrollbar {
        width: 8px;
      }
      .sub-container::-webkit-scrollbar-track {
        background: #2d3748;
        border-radius: 10px;
      }
      .sub-container::-webkit-scrollbar-thumb {
        background: #4a5568;
        border-radius: 10px;
      }
      .sub-container::-webkit-scrollbar-thumb:hover {
        background: #718096;
      }

      .sub-block {
        background-color: #2d3748;
        border-radius: 0.5rem;
        padding: 0.75rem;
        margin-bottom: 1rem;
        border-left: 3px solid #4a5568;
        transition: background-color 0.2s ease, border-left-color 0.2s ease;
      }
      .sub-block.highlighted {
        background-color: #4c51bf;
        border-left-color: #a3bffa;
      }
      .sub-block.warning-highlight {
        border-left-color: #f59e0b; /* amber-500 */
        background-color: #4a4a2a;
      }
      .sub-index {
        font-size: 0.75rem;
        color: #a0aec0; /* gray-400 */
        margin-bottom: 0.25rem;
      }
      .sub-time {
        font-size: 0.8rem;
        color: #e2e8f0; /* gray-300 */
        margin-bottom: 0.5rem;
        font-family: monospace;
      }
      .sub-text {
        color: #f7fafc; /* gray-100 */
        line-height: 1.6;
        outline: none;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-200">
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
      <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-white mb-2">
          Trình Dịch Phụ Đề SRT
        </h1>
        <p class="text-lg text-gray-400">
          Dịch phụ đề từ tiếng Trung sang tiếng Việt, đảm bảo tính nhất quán với
          Gemini AI.
        </p>
      </header>

      <main class="grid grid-cols-1 md:grid-cols-12 gap-8">
        <!-- Cột điều khiển -->
        <div
          class="md:col-span-4 bg-gray-800 rounded-lg p-6 shadow-lg self-start"
        >
          <div class="space-y-6">
            <div>
              <h2 class="text-xl font-semibold mb-3 text-white">
                <span class="text-gray-500 mr-2">1</span> Tải Lên & Cài Đặt
              </h2>
              <label
                for="file-upload"
                class="custom-file-upload w-full p-6 text-center rounded-lg cursor-pointer block mb-4"
              >
                <i class="fas fa-file-upload text-3xl text-gray-500 mb-2"></i>
                <span id="file-name" class="text-gray-400 text-sm"
                  >Tải lên tệp .srt</span
                >
              </label>
              <input
                id="file-upload"
                type="file"
                accept=".srt"
                class="hidden"
              />

              <div class="space-y-2">
                <div>
                  <label
                    for="analysisApiKeyInput"
                    class="text-sm font-medium text-gray-300"
                    >Analysis API Key (Tùy chọn)</label
                  >
                  <input
                    type="password"
                    id="analysisApiKeyInput"
                    placeholder="API Key cho phân tích nhân vật"
                    class="mt-1 w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  />
                </div>
                <div>
                  <label
                    for="storyApiKeyInput"
                    class="text-sm font-medium text-gray-300"
                    >Story API Key (Tùy chọn)</label
                  >
                  <input
                    type="password"
                    id="storyApiKeyInput"
                    placeholder="API Key cho tạo truyện"
                    class="mt-1 w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  />
                </div>
                <div>
                  <label
                    for="translateApiKeyInput"
                    class="text-sm font-medium text-gray-300"
                    >Translation API Key (Tùy chọn)</label
                  >
                  <input
                    type="password"
                    id="translateApiKeyInput"
                    placeholder="API Key cho dịch phụ đề"
                    class="mt-1 w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  />
                </div>
              </div>
            </div>

            <div>
              <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold text-white">
                  <span class="text-gray-500 mr-2">2</span> Phân Tích Nhân Vật
                  (Bắt buộc)
                </h2>
                <i
                  id="fullscreen-analysis-btn"
                  class="fas fa-expand-arrows-alt text-gray-400 hover:text-white cursor-pointer hidden"
                  title="Xem toàn màn hình"
                ></i>
              </div>
              <button
                id="analyzeCharactersBtn"
                class="w-full mb-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed"
                disabled
              >
                <i class="fas fa-brain mr-2"></i> Phân Tích Sâu Nhân Vật
              </button>
              <div class="flex gap-2">
                <button
                  id="saveProfileBtn"
                  class="w-1/2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg text-sm"
                >
                  <i class="fas fa-save mr-2"></i>Lưu
                </button>
                <button
                  id="loadProfileBtn"
                  class="w-1/2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg text-sm"
                >
                  <i class="fas fa-folder-open mr-2"></i>Tải
                </button>
                <input
                  type="file"
                  id="profile-loader"
                  class="hidden"
                  accept=".json"
                />
              </div>
              <div id="analysis-status" class="text-center text-sm my-3"></div>
              <div
                id="characterMapContainer"
                class="max-h-60 overflow-y-auto pr-2"
              ></div>
            </div>

            <div>
              <h2 class="text-xl font-semibold mb-3 text-white">
                <span class="text-gray-500 mr-2">3</span> Tạo Truyện Hoàn Chỉnh
              </h2>
              <p class="text-sm text-gray-400 mb-3">
                Tạo truyện để làm ngữ cảnh tham khảo cho quá trình dịch.
              </p>
              <button
                id="generateStoryBtn"
                class="w-full mb-2 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed"
                disabled
              >
                <i class="fas fa-book-open mr-2"></i> Tạo Truyện
              </button>
              <div id="story-status" class="text-center text-sm my-3"></div>
              <div class="space-y-3 mt-4">
                <label
                  for="story-context-input"
                  class="text-sm font-medium text-gray-300"
                  >Thêm Bối Cảnh (Tùy chọn)</label
                >
                <textarea
                  id="story-context-input"
                  rows="3"
                  class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="Dán tóm tắt truyện, thông tin nhân vật..."
                ></textarea>
                <div class="flex items-center gap-2">
                  <label
                    for="docx-upload"
                    class="cursor-pointer text-sm inline-flex items-center px-3 py-1 bg-gray-600 text-gray-300 rounded-md hover:bg-gray-700 transition duration-300"
                  >
                    <i class="fas fa-file-word mr-2"></i> Tải .docx
                  </label>
                  <input
                    id="docx-upload"
                    type="file"
                    class="hidden"
                    accept=".docx"
                  />
                  <span
                    id="docx-file-name"
                    class="text-xs text-gray-500 truncate"
                  ></span>
                </div>
                <div class="flex items-center gap-2">
                  <label
                    for="srt-context-upload"
                    class="cursor-pointer text-sm inline-flex items-center px-3 py-1 bg-gray-600 text-gray-300 rounded-md hover:bg-gray-700 transition duration-300"
                  >
                    <i class="fas fa-file-alt mr-2"></i> Tải .srt Nguồn
                  </label>
                  <input
                    id="srt-context-upload"
                    type="file"
                    class="hidden"
                    accept=".srt"
                  />
                  <span
                    id="srt-context-file-name"
                    class="text-xs text-gray-500 truncate"
                  ></span>
                </div>
              </div>
            </div>

            <div>
              <h2 class="text-xl font-semibold mb-3 text-white">
                <span class="text-gray-500 mr-2">4</span> Dịch Phụ Đề
              </h2>
              <div class="mb-4">
                <label
                  for="genre-select"
                  class="block text-sm font-medium text-gray-300 mb-1"
                  >Chọn Thể Loại Dịch</label
                >
                <select
                  id="genre-select"
                  class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                >
                  <option value="chung">Chung / Mặc định</option>
                  <option value="tu tiên">Tu tiên / Tiên hiệp</option>
                  <option value="cổ trang">Cổ trang / Lịch sử</option>
                  <option value="hiện đại">Hiện đại</option>
                  <option value="kiếm hiệp">Kiếm hiệp</option>
                  <option value="khoa huyễn">Khoa huyễn (Sci-fi)</option>
                </select>
              </div>
              <button
                id="translateBtn"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed"
                disabled
              >
                <i class="fas fa-language mr-2"></i> Dịch Ngay
              </button>
            </div>

            <div class="border-t border-gray-700 pt-6">
              <h2 class="text-xl font-semibold mb-3 text-white">
                <span class="text-gray-500 mr-2">5</span> Tự Động Hóa
              </h2>
              <p class="text-sm text-gray-400 mb-3">
                Tự động chạy các bước Phân tích, Tạo truyện & Dịch.
              </p>
              <button
                id="runAllBtn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed"
                disabled
              >
                <i class="fas fa-robot mr-2"></i> Chạy Tất Cả
              </button>
            </div>
          </div>
          <div id="status" class="mt-6 text-center"></div>
        </div>

        <!-- Cột kết quả -->
        <div class="md:col-span-8">
          <div
            id="loading-container"
            class="hidden flex-col items-center justify-center h-full bg-gray-800 rounded-lg p-6"
          >
            <div id="loader"></div>
            <p id="loading-text" class="mt-4 text-lg font-semibold text-white">
              Đang chuẩn bị dịch...
            </p>
            <div id="progress-bar-container"><div id="progress-bar"></div></div>
          </div>
          <div id="result-container" class="hidden">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
              <div class="flex items-center gap-4">
                <h2 class="text-2xl font-bold text-white">Kết Quả Dịch</h2>
                <i
                  id="toggle-size-btn"
                  class="fas fa-expand-alt text-gray-400 hover:text-white cursor-pointer"
                  title="Phóng to / Thu nhỏ"
                ></i>
              </div>
              <button
                id="downloadBtn"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
              >
                <i class="fas fa-download mr-2"></i> Tải Xuống Phụ Đề
              </button>
            </div>

            <div class="bg-gray-800 rounded-lg p-4 mb-4">
              <h3 class="text-lg font-semibold mb-3">Công Cụ Chỉnh Sửa</h3>
              <div class="flex flex-wrap gap-2">
                <input
                  type="text"
                  id="find-input"
                  placeholder="Tìm kiếm..."
                  class="flex-grow bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
                <input
                  type="text"
                  id="replace-input"
                  placeholder="Thay thế bằng..."
                  class="flex-grow bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
                <button
                  id="replace-all-btn"
                  class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg"
                >
                  <i class="fas fa-exchange-alt mr-2"></i>Thay Thế
                </button>
                <button
                  id="check-chinese-btn"
                  class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-4 rounded-lg"
                >
                  <i class="fas fa-search mr-2"></i>Rà Soát
                </button>
                <button
                  id="retranslate-issues-btn"
                  class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg hidden"
                >
                  <i class="fas fa-sync-alt mr-2"></i>Dịch Lại Lỗi
                </button>
              </div>
              <div id="edit-tool-status" class="text-sm mt-2 text-center"></div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <h3
                  class="text-lg font-semibold mb-2 text-center text-gray-300"
                >
                  Gốc (Tiếng Trung)
                </h3>
                <div id="original-sub" class="sub-container"></div>
              </div>
              <div>
                <h3 class="text-lg font-semibold mb-2 text-center text-white">
                  Dịch (Tiếng Việt) - Có thể sửa
                </h3>
                <div id="translated-sub" class="sub-container"></div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Modals -->
    <div
      id="analysis-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4"
    >
      <div
        id="analysis-modal-content-wrapper"
        class="bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl h-[90vh] flex flex-col"
      >
        <div
          class="flex justify-between items-center p-4 border-b border-gray-700"
        >
          <h2 id="modal-title" class="text-2xl font-bold text-white">
            Bản Phân Tích Nhân Vật Chi Tiết
          </h2>
          <button
            id="close-modal-btn"
            class="text-gray-400 hover:text-white text-3xl font-bold"
          >
            &times;
          </button>
        </div>
        <div id="modal-content" class="p-6 overflow-y-auto flex-1 min-h-0">
          <!-- Content will be injected here -->
        </div>
      </div>
    </div>

    <script>
      // Element selectors
      const fileUpload = document.getElementById("file-upload"),
        fileNameDisplay = document.getElementById("file-name");
      const translateBtn = document.getElementById("translateBtn"),
        downloadBtn = document.getElementById("downloadBtn");
      const statusDiv = document.getElementById("status"),
        originalSubDiv = document.getElementById("original-sub"),
        translatedSubDiv = document.getElementById("translated-sub");
      const loadingContainer = document.getElementById("loading-container"),
        loadingText = document.getElementById("loading-text");
      const resultContainer = document.getElementById("result-container"),
        characterMapContainer = document.getElementById(
          "characterMapContainer"
        );
      const analysisApiKeyInput = document.getElementById(
          "analysisApiKeyInput"
        ),
        storyApiKeyInput = document.getElementById("storyApiKeyInput"),
        translateApiKeyInput = document.getElementById("translateApiKeyInput");
      const analyzeCharactersBtn = document.getElementById(
          "analyzeCharactersBtn"
        ),
        analysisStatus = document.getElementById("analysis-status");
      const saveProfileBtn = document.getElementById("saveProfileBtn"),
        loadProfileBtn = document.getElementById("loadProfileBtn"),
        profileLoader = document.getElementById("profile-loader");
      const progressBar = document.getElementById("progress-bar");
      const findInput = document.getElementById("find-input"),
        replaceInput = document.getElementById("replace-input"),
        replaceAllBtn = document.getElementById("replace-all-btn");
      const genreSelect = document.getElementById("genre-select");
      const fullscreenBtn = document.getElementById("fullscreen-analysis-btn");
      const analysisModal = document.getElementById("analysis-modal");
      const closeModalBtn = document.getElementById("close-modal-btn");
      const modalContent = document.getElementById("modal-content");
      const modalTitle = document.getElementById("modal-title");
      const generateStoryBtn = document.getElementById("generateStoryBtn");
      const storyStatus = document.getElementById("story-status");
      const runAllBtn = document.getElementById("runAllBtn");
      const toggleSizeBtn = document.getElementById("toggle-size-btn");
      const checkChineseBtn = document.getElementById("check-chinese-btn");
      const editToolStatus = document.getElementById("edit-tool-status");
      const retranslateIssuesBtn = document.getElementById(
        "retranslate-issues-btn"
      );
      const storyContextInput = document.getElementById("story-context-input");
      const docxUpload = document.getElementById("docx-upload");
      const docxFileName = document.getElementById("docx-file-name");
      const srtContextUpload = document.getElementById("srt-context-upload");
      const srtContextFileName = document.getElementById(
        "srt-context-file-name"
      );

      let originalSrtContent = "",
        translatedSrtContent = "",
        originalFileName = "";
      let parsedSubs = [],
        translatedParsedSubs = [];
      let userAnalysisApiKey = "",
        userStoryApiKey = "",
        userTranslateApiKey = "";
      let storyContext = "";
      let docxStoryContext = "";
      let srtStoryContext = "";
      let untranslatedIndices = [];

      // --- Event Listeners ---
      analysisApiKeyInput.addEventListener("input", (e) => {
        userAnalysisApiKey = e.target.value.trim();
        localStorage.setItem("analysisApiKey", userAnalysisApiKey);
      });
      storyApiKeyInput.addEventListener("input", (e) => {
        userStoryApiKey = e.target.value.trim();
        localStorage.setItem("storyApiKey", userStoryApiKey);
      });
      translateApiKeyInput.addEventListener("input", (e) => {
        userTranslateApiKey = e.target.value.trim();
        localStorage.setItem("translateApiKey", userTranslateApiKey);
      });
      fileUpload.addEventListener("change", handleFileSelect);
      const fileLabel = fileUpload.previousElementSibling;
      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) =>
        fileLabel.addEventListener(
          eventName,
          (e) => {
            e.preventDefault();
            e.stopPropagation();
          },
          false
        )
      );
      ["dragenter", "dragover"].forEach((eventName) =>
        fileLabel.addEventListener(
          eventName,
          () => fileLabel.classList.add("dragover"),
          false
        )
      );
      ["dragleave", "drop"].forEach((eventName) =>
        fileLabel.addEventListener(
          eventName,
          () => fileLabel.classList.remove("dragover"),
          false
        )
      );
      fileLabel.addEventListener("drop", handleDrop, false);
      analyzeCharactersBtn.addEventListener("click", runCharacterAnalysis);
      generateStoryBtn.addEventListener("click", runStoryGeneration);
      runAllBtn.addEventListener("click", runFullWorkflow);
      saveProfileBtn.addEventListener("click", saveCharacterProfile);
      loadProfileBtn.addEventListener("click", () => profileLoader.click());
      profileLoader.addEventListener("change", loadCharacterProfile);
      translateBtn.addEventListener("click", runTranslation);
      retranslateIssuesBtn.addEventListener("click", retranslateIssues);
      docxUpload.addEventListener("change", handleDocxUpload);
      srtContextUpload.addEventListener("change", handleSrtContextUpload);
      translatedSubDiv.addEventListener("input", (e) => {
        if (e.target.classList.contains("sub-text")) {
          const arrayIndex = parseInt(e.target.dataset.arrayIndex, 10);
          if (!isNaN(arrayIndex) && translatedParsedSubs[arrayIndex]) {
            translatedParsedSubs[arrayIndex].text = e.target.textContent;
            translatedSrtContent = buildSRT(translatedParsedSubs);
          }
        }
      });
      translatedSubDiv.addEventListener("focusin", (e) => {
        if (e.target.classList.contains("sub-text")) {
          document
            .querySelectorAll(".sub-block.highlighted")
            .forEach((el) => el.classList.remove("highlighted"));
          const arrayIndex = e.target.dataset.arrayIndex;
          const originalBlock = document.getElementById(
            `original-sub-block-${arrayIndex}`
          );
          const translatedBlock = e.target.closest(".sub-block");
          if (originalBlock) {
            originalBlock.classList.add("highlighted");
            originalBlock.scrollIntoView({
              behavior: "smooth",
              block: "center",
            });
          }
          if (translatedBlock) translatedBlock.classList.add("highlighted");
        }
      });
      replaceAllBtn.addEventListener("click", handleFindAndReplace);
      checkChineseBtn.addEventListener("click", checkRemainingChinese);
      downloadBtn.addEventListener("click", downloadSRT);
      fullscreenBtn.addEventListener("click", () =>
        showModalWithContent("analysis")
      );
      closeModalBtn.addEventListener("click", hideAnalysisModal);
      analysisModal.addEventListener("click", (e) => {
        if (e.target.id === "analysis-modal") {
          hideAnalysisModal();
        }
      });
      toggleSizeBtn.addEventListener("click", () => {
        const isExpanded = originalSubDiv.classList.contains("expanded");
        originalSubDiv.classList.toggle("expanded");
        translatedSubDiv.classList.toggle("expanded");
        if (isExpanded) {
          toggleSizeBtn.classList.remove("fa-compress-alt");
          toggleSizeBtn.classList.add("fa-expand-alt");
          toggleSizeBtn.title = "Phóng to";
        } else {
          toggleSizeBtn.classList.remove("fa-expand-alt");
          toggleSizeBtn.classList.add("fa-compress-alt");
          toggleSizeBtn.title = "Thu nhỏ";
        }
      });

      // --- Load API Keys on Startup ---
      function loadApiKeys() {
        const savedAnalysisKey = localStorage.getItem("analysisApiKey");
        if (savedAnalysisKey) {
          analysisApiKeyInput.value = savedAnalysisKey;
          userAnalysisApiKey = savedAnalysisKey;
        }
        const savedStoryKey = localStorage.getItem("storyApiKey");
        if (savedStoryKey) {
          storyApiKeyInput.value = savedStoryKey;
          userStoryApiKey = savedStoryKey;
        }
        const savedTranslateKey = localStorage.getItem("translateApiKey");
        if (savedTranslateKey) {
          translateApiKeyInput.value = savedTranslateKey;
          userTranslateApiKey = savedTranslateKey;
        }
      }
      loadApiKeys(); // Call on script load

      function handleDrop(e) {
        if (e.dataTransfer.files.length > 0) {
          fileUpload.files = e.dataTransfer.files;
          handleFileSelect({ target: fileUpload });
        }
      }

      function handleFileSelect(event) {
        const file = event.target.files[0];
        characterMapContainer.innerHTML = "";
        analysisStatus.textContent = "";
        storyStatus.textContent = "";
        storyContext = "";
        fullscreenBtn.classList.add("hidden");
        if (file && file.name.endsWith(".srt")) {
          originalFileName = file.name.replace(".srt", "");
          fileNameDisplay.textContent = file.name;
          fileNameDisplay.classList.add("text-green-400");
          analyzeCharactersBtn.disabled = false;
          generateStoryBtn.disabled = true; // Still disabled until analysis
          translateBtn.disabled = true;
          runAllBtn.disabled = true; // Disabled until analysis
          const reader = new FileReader();
          reader.onload = (e) => {
            originalSrtContent = e.target.result;
            parsedSubs = parseSRT(originalSrtContent);
            displaySubtitles(parsedSubs, originalSubDiv);
          };
          reader.readAsText(file);
        } else {
          fileNameDisplay.textContent = "Vui lòng chọn tệp .srt hợp lệ";
          fileNameDisplay.classList.remove("text-green-400");
          [
            translateBtn,
            analyzeCharactersBtn,
            generateStoryBtn,
            runAllBtn,
          ].forEach((btn) => (btn.disabled = true));
          originalFileName = "";
          originalSrtContent = "";
          parsedSubs = [];
        }
      }

      // --- Modal Logic ---
      function showModalWithContent(type) {
        if (type === "analysis") {
          if (characterMapContainer.innerHTML.trim() === "") {
            analysisStatus.textContent = "Chưa có phân tích nào để hiển thị.";
            analysisStatus.className = "text-yellow-400";
            return;
          }
          modalTitle.textContent = "Bản Phân Tích Nhân Vật Chi Tiết";
          const clonedContent = characterMapContainer.cloneNode(true);
          clonedContent.classList.remove("max-h-60", "overflow-y-auto");
          modalContent.innerHTML = "";
          modalContent.appendChild(clonedContent);
          modalContent.classList.remove("modal-prose");
        } else if (type === "story") {
          if (storyContext === "") {
            storyStatus.textContent = "Chưa có câu chuyện nào để hiển thị.";
            storyStatus.className = "text-yellow-400";
            return;
          }
          modalTitle.textContent = "Câu Chuyện Hoàn Chỉnh";
          modalContent.innerHTML = `<div class="modal-prose">${storyContext.replace(
            /\n/g,
            "<p>"
          )}</div>`;
          modalContent.classList.add("modal-prose");
        }
        analysisModal.classList.remove("hidden");
      }

      function hideAnalysisModal() {
        analysisModal.classList.add("hidden");
      }

      // --- Character Profile Logic ---
      function getCharacterContext() {
        const entries = characterMapContainer.querySelectorAll(
          ".character-profile-card"
        );
        if (entries.length === 0) return "";
        let contextText =
          "BỐI CẢNH NHÂN VẬT (CỰC KỲ QUAN TRỌNG, HÃY TUÂN THỦ NGHIÊM NGẶT):\n";
        entries.forEach((entry) => {
          const originalName = entry
            .querySelector(".original-name-display")
            .textContent.split(":")[0]
            .trim();
          const phoneticName = entry
            .querySelector(".original-name-display")
            .textContent.split(":")[1]
            .trim();
          const translationRule = entry
            .querySelector(".translation-rule-input")
            .value.trim();
          const background =
            entry.querySelector(".background-summary-p")?.textContent.trim() ||
            "Không có";
          const relationships =
            entry.querySelector(".relationships-p")?.textContent.trim() ||
            "Không có";
          if (originalName && translationRule) {
            contextText += `\n- NHÂN VẬT: ${originalName} (phiên âm: ${phoneticName})\n  - QUY TẮC DỊCH TÊN/XƯNG HÔ CHÍNH: ${translationRule}\n  - BỐI CẢNH: ${background}\n  - CÁC MỐI QUAN HỆ: ${relationships}\n`;
          }
        });
        return contextText;
      }

      function saveCharacterProfile() {
        const profiles = [];
        characterMapContainer
          .querySelectorAll(".character-profile-card")
          .forEach((card) => {
            const [originalName, phoneticName] = card
              .querySelector(".original-name-display")
              .textContent.split(":")
              .map((s) => s.trim());
            profiles.push({
              full_chinese_name: originalName,
              vietnamese_phonetic_name: phoneticName,
              translation_rule: card.querySelector(".translation-rule-input")
                .value,
            });
          });
        if (profiles.length === 0) return;
        const blob = new Blob([JSON.stringify(profiles, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${originalFileName}_characters.json`;
        a.click();
        URL.revokeObjectURL(url);
      }

      function loadCharacterProfile(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const profiles = JSON.parse(e.target.result);
            characterMapContainer.innerHTML = "";
            analysisStatus.textContent = `Đã tải ${profiles.length} hồ sơ nhân vật.`;
            analysisStatus.className = "text-green-500";
            profiles.forEach((prof) => {
              const entry = document.createElement("div");
              entry.className = "character-profile-card";
              entry.innerHTML = `<h4 class="original-name-display text-lg font-bold text-white mb-3">${prof.full_chinese_name}: ${prof.vietnamese_phonetic_name}</h4><div class="flex gap-2"><input type="text" value="${prof.translation_rule}" placeholder="Quy tắc dịch tên/xưng hô..." class="translation-rule-input w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-1 text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"></div>`;
              characterMapContainer.appendChild(entry);
            });
            if (profiles.length > 0) {
              fullscreenBtn.classList.remove("hidden");
              generateStoryBtn.disabled = false;
              translateBtn.disabled = false;
              runAllBtn.disabled = false;
            }
          } catch (error) {
            analysisStatus.textContent = "Lỗi: Tệp hồ sơ không hợp lệ.";
            analysisStatus.className = "text-red-500";
          }
        };
        reader.readAsText(file);
      }

      async function runCharacterAnalysis() {
        if (parsedSubs.length === 0)
          throw new Error("Vui lòng tải tệp SRT trước.");

        analysisStatus.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Đang phân tích, vui lòng chờ...`;
        analysisStatus.className =
          "text-blue-400 flex items-center justify-center";
        analyzeCharactersBtn.disabled = true;

        try {
          const sampleText = parsedSubs
            .slice(0, Math.min(parsedSubs.length, 200))
            .map((sub) => sub.text)
            .join("\n");
          const characters = await analyzeCharactersWithAI(sampleText);

          characterMapContainer.innerHTML = "";
          if (characters.length === 0) {
            analysisStatus.textContent = "Không tìm thấy nhân vật nào đáng kể.";
            analysisStatus.className = "text-gray-400";
          } else {
            characters.forEach((char) => {
              const entry = document.createElement("div");
              entry.className = "character-profile-card";
              entry.innerHTML = `<div class="flex justify-between items-start mb-2"><h4 class="original-name-display text-lg font-bold text-white">${char.full_chinese_name}: ${char.vietnamese_phonetic_name}</h4><div class="text-right text-xs"><p class="text-gray-400">${char.gender}</p><p class="text-gray-400">~ ${char.estimated_age} tuổi</p></div></div><div class="mb-3"><p class="text-sm font-semibold text-gray-300 mb-1">Bối cảnh nhân vật:</p><p class="background-summary-p text-sm text-gray-400 bg-gray-900 p-2 rounded">${char.background_summary}</p></div><div class="mb-3"><p class="text-sm font-semibold text-gray-300 mb-1">Mối quan hệ & Xưng hô:</p><p class="relationships-p text-sm text-gray-400 bg-gray-900 p-2 rounded">${char.relationships}</p></div><div class="flex gap-2"><input type="text" value="${char.vietnamese_phonetic_name}" placeholder="Quy tắc dịch tên/xưng hô..." class="translation-rule-input w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-1 text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"></div>`;
              characterMapContainer.appendChild(entry);
            });
            analysisStatus.textContent = `Phân tích xong! Đã tìm thấy ${characters.length} nhân vật.`;
            analysisStatus.className = "text-green-500";
            fullscreenBtn.classList.remove("hidden");
            generateStoryBtn.disabled = false;
            translateBtn.disabled = false;
            runAllBtn.disabled = false;
          }
        } catch (error) {
          console.error("Lỗi phân tích nhân vật:", error);
          analysisStatus.textContent = `Lỗi: ${error.message}`;
          analysisStatus.className = "text-red-500";
          throw error;
        } finally {
          analyzeCharactersBtn.disabled = false;
        }
      }

      async function analyzeCharactersWithAI(text) {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${
          userAnalysisApiKey || ""
        }`;
        const systemPrompt = `Bạn là một chuyên gia phân tích kịch bản cực kỳ tỉ mỉ. Nhiệm vụ của bạn là đọc phụ đề và phân tích TOÀN BỘ các nhân vật.\n- ƯU TIÊN SỐ 1: Phải xác định được HỌ VÀ TÊN ĐẦY ĐỦ của nhân vật nếu có.\n- TRƯỜNG HỢP NGOẠI LỆ: Nếu nhân vật không có tên riêng mà chỉ được gọi bằng danh xưng, chức vụ (ví dụ: 'giáo viên', 'cảnh sát'), hãy giữ nguyên danh xưng đó.\n- YÊU CẦU: Bạn phải quét toàn bộ văn bản, liệt kê TẤT CẢ các nhân vật, kể cả người chỉ được nhắc tên một lần, và KHÔNG ĐƯỢC BỎ SÓT.`;
        const userPrompt = `Phân tích tất cả nhân vật trong phụ đề sau. Với mỗi nhân vật, hãy cung cấp chính xác các mục sau:\n1. 'full_chinese_name': HỌ VÀ TÊN ĐẦY ĐỦ, CHÍNH XÁC của nhân vật (ví dụ: 'Lý Mộ Bạch'). Nếu không có tên đầy đủ, hãy sử dụng danh xưng hoặc chức vụ (ví dụ: '美术老师'). Đây là yêu cầu bắt buộc.\n2. 'vietnamese_phonetic_name': Tên của nhân vật đó được phiên âm Hán-Việt, hoặc dịch danh xưng (ví dụ: 'Giáo viên mỹ thuật').\n3. 'gender': Giới tính.\n4. 'estimated_age': Tuổi ước tính.\n5. 'background_summary': Tóm tắt ngắn gọn về bối cảnh, xuất thân của nhân vật.\n6. 'relationships': Tóm tắt các mối quan hệ chính và cách xưng hô của nhân vật này với những người khác.\n\nKhông bỏ sót bất kỳ ai. Trả về dưới dạng một mảng JSON hợp lệ theo format đã mô tả. Không thêm bất kỳ văn bản nào khác. \n\nPhụ đề:\n\n${text}`;

        const payload = {
          contents: [{ parts: [{ text: userPrompt }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: {
            responseMimeType: "application/json",
            responseSchema: {
              type: "ARRAY",
              items: {
                type: "OBJECT",
                properties: {
                  full_chinese_name: { type: "STRING" },
                  vietnamese_phonetic_name: { type: "STRING" },
                  gender: { type: "STRING" },
                  estimated_age: { type: "STRING" },
                  background_summary: { type: "STRING" },
                  relationships: { type: "STRING" },
                },
                required: [
                  "full_chinese_name",
                  "vietnamese_phonetic_name",
                  "gender",
                  "estimated_age",
                  "background_summary",
                  "relationships",
                ],
              },
            },
          },
          safetySettings: [
            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
            {
              category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
              threshold: "BLOCK_NONE",
            },
            {
              category: "HARM_CATEGORY_DANGEROUS_CONTENT",
              threshold: "BLOCK_NONE",
            },
          ],
        };
        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!response.ok)
          throw new Error(
            `Lỗi API phân tích: ${response.status} ${await response.text()}`
          );
        const result = await response.json();
        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!jsonText) throw new Error("Phản hồi AI không chứa JSON.");
        return JSON.parse(jsonText);
      }

      // --- Story Generation ---
      function cleanSrtForStory(srtContent) {
        return srtContent
          .replace(/\r/g, "")
          .split("\n\n")
          .map((block) => {
            const lines = block.split("\n");
            return lines.length >= 3 ? lines.slice(2).join(" ") : "";
          })
          .filter((line) => line.trim() !== "")
          .join("\n");
      }

      async function runStoryGeneration() {
        const mainSrtText = originalSrtContent
          ? cleanSrtForStory(originalSrtContent)
          : "";
        const sourceTextForStory = srtStoryContext || mainSrtText;

        if (!sourceTextForStory) {
          storyStatus.textContent =
            "Vui lòng tải lên tệp SRT ở Bước 1 hoặc trong mục này để tạo truyện.";
          storyStatus.className = "text-yellow-400";
          return;
        }

        storyStatus.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> AI đang sáng tác...`;
        storyStatus.className =
          "text-blue-400 flex items-center justify-center";
        generateStoryBtn.disabled = true;
        try {
          const combinedSubtitleText = [mainSrtText, srtStoryContext]
            .filter(Boolean)
            .join("\n\n");
          const extraContext = [storyContextInput.value, docxStoryContext]
            .filter(Boolean)
            .join("\n\n---\n\n");
          storyContext = await generateStoryWithAI(
            combinedSubtitleText,
            extraContext
          );
          storyStatus.innerHTML = `Đã tạo xong! <span class="underline cursor-pointer ml-2" onclick="showModalWithContent('story')">Xem truyện</span>`;
          storyStatus.className = "text-green-500";
        } catch (error) {
          console.error("Lỗi khi tạo truyện:", error);
          storyStatus.textContent = `Lỗi: ${error.message}`;
          storyStatus.className = "text-red-500";
          throw error;
        } finally {
          generateStoryBtn.disabled = false;
        }
      }

      async function generateStoryWithAI(subtitleText, extraContext) {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${
          userStoryApiKey || ""
        }`;
        const systemPrompt = `Bạn là một người kể chuyện chuyên nghiệp. Nhiệm vụ của bạn là chuyển đổi nội dung của một tệp phụ đề (chỉ chứa lời thoại) thành một câu chuyện tường thuật HOÀN CHỈNH bằng tiếng Việt.`;
        const userPrompt = `Dựa vào nội dung phụ đề chính dưới đây, và có tham khảo thêm các thông tin bối cảnh bổ sung (nếu có), hãy viết một câu chuyện tường thuật HOÀN CHỈNH bằng tiếng Việt.
- **Yêu cầu:**
  - Viết thành một câu chuyện hoàn chỉnh, có mở đầu, diễn biến và kết thúc hợp lý.
  - Văn phong tự nhiên, mạch lạc, hấp dẫn.

**Bối cảnh bổ sung (để tham khảo):**
${extraContext || "Không có."}

**Nội dung phụ đề chính (nguồn chính để viết truyện):**
${subtitleText}`;

        const payload = {
          contents: [{ parts: [{ text: userPrompt }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          safetySettings: [
            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
            {
              category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
              threshold: "BLOCK_NONE",
            },
            {
              category: "HARM_CATEGORY_DANGEROUS_CONTENT",
              threshold: "BLOCK_NONE",
            },
          ],
        };

        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!response.ok)
          throw new Error(
            `Lỗi API tạo truyện: ${response.status} ${await response.text()}`
          );
        const result = await response.json();
        const candidate = result.candidates?.[0];
        if (candidate?.content?.parts?.[0]?.text)
          return candidate.content.parts[0].text;
        throw new Error(
          "Phản hồi API không hợp lệ hoặc không chứa nội dung truyện."
        );
      }

      function handleDocxUpload(event) {
        const file = event.target.files[0];
        if (!file) {
          docxFileName.textContent = "";
          return;
        }
        docxFileName.textContent = file.name;
        const reader = new FileReader();
        reader.onload = function (e) {
          mammoth
            .extractRawText({ arrayBuffer: e.target.result })
            .then((result) => {
              docxStoryContext = result.value;
              docxFileName.classList.add("text-green-400");
            })
            .catch((err) => {
              console.error("Lỗi đọc file .docx:", err);
              docxFileName.textContent = "Lỗi đọc file";
              docxFileName.classList.add("text-red-400");
            });
        };
        reader.readAsArrayBuffer(file);
      }

      function handleSrtContextUpload(event) {
        const file = event.target.files[0];
        if (!file) {
          srtContextFileName.textContent = "";
          return;
        }
        srtContextFileName.textContent = file.name;
        const reader = new FileReader();
        reader.onload = (e) => {
          srtStoryContext = cleanSrtForStory(e.target.result);
          srtContextFileName.classList.add("text-green-400");
          generateStoryBtn.disabled = false; // Enable story generation when context file is added
        };
        reader.readAsText(file);
      }

      // --- SRT Utilities ---
      function parseSRT(data) {
        return data
          .replace(/\r/g, "")
          .split("\n\n")
          .filter(Boolean)
          .map((block) => {
            const lines = block.split("\n");
            return lines.length >= 3
              ? {
                  index: lines[0],
                  time: lines[1],
                  text: lines.slice(2).join("\n"),
                }
              : null;
          })
          .filter(Boolean);
      }
      function buildSRT(subs) {
        return subs
          .map((sub) => `${sub.index}\n${sub.time}\n${sub.text}`)
          .join("\n\n");
      }

      function displaySubtitles(subs, element, isEditable = false) {
        element.innerHTML = ""; // Clear previous content
        subs.forEach((sub, i) => {
          const block = document.createElement("div");
          block.id = `${element.id}-block-${i}`;
          block.className = "sub-block";
          const indexEl = document.createElement("div");
          indexEl.className = "sub-index";
          indexEl.textContent = sub.index;
          const timeEl = document.createElement("div");
          timeEl.className = "sub-time";
          timeEl.textContent = sub.time;
          const textEl = document.createElement("div");
          textEl.className = "sub-text";
          textEl.textContent = sub.text;
          if (isEditable) {
            textEl.contentEditable = true;
            textEl.dataset.arrayIndex = i;
          }
          block.append(indexEl, timeEl, textEl);
          element.appendChild(block);
        });
      }

      // --- Translation & Editing ---
      async function runTranslation() {
        if (parsedSubs.length === 0)
          throw new Error("Không có nội dung để dịch.");
        translateBtn.disabled = true;
        resultContainer.classList.add("hidden");
        loadingContainer.classList.remove("hidden");
        loadingContainer.classList.add("flex");
        statusDiv.textContent = "";
        translatedSubDiv.innerHTML = "";
        progressBar.style.width = "0%";

        const CHUNK_SIZE = 30;
        const characterContext = getCharacterContext();
        const selectedGenre = genreSelect.value;
        translatedParsedSubs = [];
        let previousChunkContext = "";
        const totalChunks = Math.ceil(parsedSubs.length / CHUNK_SIZE);
        try {
          for (let i = 0; i < parsedSubs.length; i += CHUNK_SIZE) {
            const chunkIndex = Math.floor(i / CHUNK_SIZE) + 1;
            loadingText.textContent = `Đang dịch khối ${chunkIndex} / ${totalChunks}...`;
            progressBar.style.width = `${(chunkIndex / totalChunks) * 100}%`;
            const chunk = parsedSubs.slice(i, i + CHUNK_SIZE);
            const textToTranslate = chunk
              .map((sub, index) => `${index + 1}:: ${sub.text}`)
              .join("\n---\n");

            let translatedText = "";
            let attempt = 0;
            const MAX_ATTEMPTS = 3;
            let isValidResponse = false;

            while (attempt < MAX_ATTEMPTS && !isValidResponse) {
              attempt++;
              try {
                translatedText = await callTranslationAPI(
                  textToTranslate,
                  characterContext,
                  selectedGenre,
                  previousChunkContext,
                  storyContext
                );
                const translatedMap = new Map();
                translatedText.split("\n---\n").forEach((block) => {
                  const match = block.trim().match(/^(\d+)::([\s\S]*)/);
                  if (match)
                    translatedMap.set(
                      parseInt(match[1], 10) - 1,
                      match[2].trim()
                    );
                });
                if (translatedMap.size === chunk.length) {
                  isValidResponse = true;
                } else {
                  console.warn(
                    `Attempt ${attempt}: Invalid response for chunk ${chunkIndex}. Expected ${chunk.length}, got ${translatedMap.size}. Retrying...`
                  );
                  if (attempt >= MAX_ATTEMPTS)
                    throw new Error(
                      `API trả về phản hồi không hợp lệ cho khối ${chunkIndex} sau ${MAX_ATTEMPTS} lần thử.`
                    );
                  await new Promise((res) => setTimeout(res, 1000 * attempt));
                }
              } catch (error) {
                if (attempt >= MAX_ATTEMPTS) throw error;
                console.warn(
                  `Attempt ${attempt}: API call failed for chunk ${chunkIndex}. Retrying...`,
                  error
                );
                await new Promise((res) => setTimeout(res, 1000 * attempt));
              }
            }

            const tempTranslatedChunk = [];
            const translatedMap = new Map();
            translatedText.split("\n---\n").forEach((block) => {
              const match = block.trim().match(/^(\d+)::([\s\S]*)/);
              if (match)
                translatedMap.set(parseInt(match[1], 10) - 1, match[2].trim());
            });
            chunk.forEach((sub, index) => {
              const newSub = { ...sub };
              newSub.text = translatedMap.has(index)
                ? translatedMap.get(index)
                : `[LỖI DỊCH] ${sub.text}`;
              translatedParsedSubs.push(newSub);
              tempTranslatedChunk.push(newSub);
            });

            previousChunkContext =
              `BỐI CẢNH TỪ NHỮNG CÂU THOẠI TRƯỚC ĐÓ (để dịch cho khớp):\n` +
              tempTranslatedChunk
                .slice(-3)
                .map((s) => s.text)
                .join("\n");
            displaySubtitles(translatedParsedSubs, translatedSubDiv, true);
            await new Promise((res) => setTimeout(res, 1000));
          }
          translatedSrtContent = buildSRT(translatedParsedSubs);
          statusDiv.textContent =
            "Dịch hoàn tất! Bạn có thể chỉnh sửa trực tiếp bên trên.";
          statusDiv.className = "text-green-500";
          resultContainer.classList.remove("hidden");
        } catch (error) {
          console.error("Lỗi dịch:", error);
          statusDiv.textContent = `Đã xảy ra lỗi: ${error.message}`;
          statusDiv.className = "text-red-500";
          throw error;
        } finally {
          loadingContainer.classList.add("hidden");
          loadingContainer.classList.remove("flex");
          translateBtn.disabled = false;
        }
      }

      // --- Full Workflow ---
      async function runFullWorkflow() {
        if (parsedSubs.length === 0) {
          statusDiv.textContent =
            "Vui lòng tải tệp SRT trước khi chạy tự động.";
          statusDiv.className = "text-yellow-400";
          return;
        }
        const buttons = [
          analyzeCharactersBtn,
          generateStoryBtn,
          translateBtn,
          runAllBtn,
        ];
        buttons.forEach((btn) => (btn.disabled = true));
        statusDiv.textContent = "Bắt đầu quy trình tự động...";
        statusDiv.className = "text-blue-400";
        try {
          statusDiv.textContent = "Bước 1/3: Đang phân tích nhân vật...";
          await runCharacterAnalysis();
          statusDiv.textContent = "Bước 2/3: Đang tạo truyện hoàn chỉnh...";
          await runStoryGeneration();
          statusDiv.textContent = "Bước 3/3: Đang dịch phụ đề...";
          await runTranslation();
          statusDiv.textContent = "Quy trình tự động hoàn tất!";
          statusDiv.className = "text-green-500";
        } catch (error) {
          console.error("Lỗi trong quy trình tự động:", error);
          statusDiv.textContent = `Lỗi trong quy trình: ${error.message}`;
          statusDiv.className = "text-red-500";
        } finally {
          if (parsedSubs.length > 0) {
            buttons.forEach((btn) => (btn.disabled = false));
            if (characterMapContainer.innerHTML.trim() === "") {
              generateStoryBtn.disabled = true;
              translateBtn.disabled = true;
              runAllBtn.disabled = true;
            }
          }
        }
      }

      function handleFindAndReplace() {
        const findValue = findInput.value;
        if (!findValue) return;
        const replaceValue = replaceInput.value;
        translatedParsedSubs.forEach((sub) => {
          sub.text = sub.text.replace(new RegExp(findValue, "g"), replaceValue);
        });
        displaySubtitles(translatedParsedSubs, translatedSubDiv, true);
        translatedSrtContent = buildSRT(translatedParsedSubs);
      }

      function checkRemainingChinese() {
        document
          .querySelectorAll(".sub-block.warning-highlight")
          .forEach((el) => el.classList.remove("warning-highlight"));
        const chineseRegex = /[\u4e00-\u9fa5]/;
        untranslatedIndices = [];
        retranslateIssuesBtn.classList.add("hidden");

        if (translatedParsedSubs.length === 0) {
          editToolStatus.textContent = "Chưa có bản dịch để rà soát.";
          editToolStatus.className = "text-sm mt-2 text-center text-yellow-400";
          return;
        }
        translatedParsedSubs.forEach((sub, i) => {
          if (chineseRegex.test(sub.text)) {
            const block = document.getElementById(`translated-sub-block-${i}`);
            if (block) {
              block.classList.add("warning-highlight");
              untranslatedIndices.push(i);
            }
          }
        });
        if (untranslatedIndices.length > 0) {
          editToolStatus.textContent = `Rà soát hoàn tất. Tìm thấy ${untranslatedIndices.length} dòng có thể còn sót tiếng Trung.`;
          editToolStatus.className = "text-sm mt-2 text-center text-yellow-400";
          retranslateIssuesBtn.classList.remove("hidden");
          const firstIssue = document.querySelector(
            ".sub-block.warning-highlight"
          );
          if (firstIssue)
            firstIssue.scrollIntoView({ behavior: "smooth", block: "center" });
        } else {
          editToolStatus.textContent =
            "Rà soát hoàn tất. Không tìm thấy ký tự tiếng Trung nào.";
          editToolStatus.className = "text-sm mt-2 text-center text-green-500";
        }
      }

      async function retranslateIssues() {
        if (untranslatedIndices.length === 0) return;

        retranslateIssuesBtn.disabled = true;
        editToolStatus.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Đang dịch lại ${untranslatedIndices.length} dòng lỗi...`;
        editToolStatus.className = "text-sm mt-2 text-center text-blue-400";

        const characterContext = getCharacterContext();
        const selectedGenre = genreSelect.value;

        let successCount = 0;

        const retranslationPromises = untranslatedIndices.map(async (index) => {
          try {
            const originalText = parsedSubs[index].text;
            const translatedText = await callTranslationAPI(
              `1:: ${originalText}`,
              characterContext,
              selectedGenre,
              "",
              storyContext
            );
            const match = translatedText.trim().match(/^1::([\s\S]*)/);
            if (match && match[1]) {
              translatedParsedSubs[index].text = match[1].trim();
              successCount++;
            }
          } catch (error) {
            console.error(`Lỗi khi dịch lại dòng index ${index}:`, error);
          }
        });

        await Promise.all(retranslationPromises);

        displaySubtitles(translatedParsedSubs, translatedSubDiv, true);
        translatedSrtContent = buildSRT(translatedParsedSubs);

        editToolStatus.textContent = `Đã dịch lại thành công ${successCount} / ${untranslatedIndices.length} dòng.`;
        editToolStatus.className = "text-sm mt-2 text-center text-green-500";

        retranslateIssuesBtn.disabled = false;
        retranslateIssuesBtn.classList.add("hidden");
        untranslatedIndices = [];

        // Re-run the check to confirm
        setTimeout(checkRemainingChinese, 500);
      }

      async function callTranslationAPI(
        text,
        characterContext,
        genre,
        previousContext,
        storyContext
      ) {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${
          userTranslateApiKey || ""
        }`;
        const genreInstruction =
          genre && genre !== "chung"
            ? `PHONG CÁCH DỊCH: Dịch theo phong cách phù hợp với thể loại '${genre}'.`
            : "";
        const systemPrompt = `Bạn là chuyên gia dịch thuật phụ đề từ tiếng Trung sang tiếng Việt. Nhiệm vụ của bạn là dịch với độ chính xác và nhất quán cao nhất dựa trên các bối cảnh được cung cấp.\n\nBỐI CẢNH CÂU CHUYỆN (để hiểu rõ hơn về mạch truyện, chỉ dùng để tham khảo, không được lấy nội dung từ đây để dịch):\n${
          storyContext || "Không có."
        }\n\n${characterContext}\n\n${previousContext}\n\nQUY TẮC TUYỆT ĐỐI:\n1. GIỮ NGUYÊN CẤU TRÚC SỐ: Đầu vào có dạng 'số:: nội dung' và phân tách bằng '---'. Đầu ra BẮT BUỘC phải giữ nguyên format 'số:: nội dung đã dịch' và dấu '---'.\n2. KHÔNG BÌNH LUẬN: Chỉ trả về nội dung dịch.\n3. ${genreInstruction}`;
        const payload = {
          contents: [{ parts: [{ text: text }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: { temperature: 0.4, topK: 1, topP: 1 },
          safetySettings: [
            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
            {
              category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
              threshold: "BLOCK_NONE",
            },
            {
              category: "HARM_CATEGORY_DANGEROUS_CONTENT",
              threshold: "BLOCK_NONE",
            },
          ],
        };
        let retries = 3,
          delay = 1000,
          response;
        while (retries > 0) {
          try {
            response = await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            if (response.ok) {
              const result = await response.json();
              const candidate = result.candidates?.[0];
              if (candidate?.content?.parts?.[0]?.text)
                return candidate.content.parts[0].text;
              if (result.promptFeedback?.blockReason)
                throw new Error(
                  `Nội dung bị chặn bởi bộ lọc an toàn: ${result.promptFeedback.blockReason}`
                );
              throw new Error(
                `Phản hồi API không hợp lệ: ${JSON.stringify(result)}`
              );
            }
            if (response.status === 429 || response.status === 503)
              throw new Error("Rate limited");
            throw new Error(
              `Lỗi HTTP: ${response.status} ${await response.text()}`
            );
          } catch (error) {
            if (
              error.message.includes("Rate limited") ||
              error.message.includes("Nội dung bị chặn")
            ) {
              retries--;
              if (retries === 0)
                throw new Error(
                  "API quá tải hoặc nội dung bị chặn. Vui lòng thử lại sau."
                );
              await new Promise((res) => setTimeout(res, delay));
              delay *= 2;
            } else throw error;
          }
        }
        throw new Error("Không thể dịch sau nhiều lần thử.");
      }

      // --- Download Logic ---
      function downloadSRT() {
        translatedSrtContent = buildSRT(translatedParsedSubs);
        if (!translatedSrtContent) return;
        const blob = new Blob([translatedSrtContent], {
          type: "text/plain;charset=utf-8",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${originalFileName}_vi.srt`;
        a.click();
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
