<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trình Dịch Phụ Đề SRT với Gemini AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <style>
      /* Giao diện được làm mới với theme màu Slate */
      body {
        font-family: "Inter", sans-serif;
        background-color: #0f172a; /* slate-900 */
      }

      .custom-file-upload {
        border: 2px dashed #475569; /* slate-600 */
        background-color: #1e293b; /* slate-800 */
        transition: all 0.3s ease;
      }
      .custom-file-upload:hover,
      .custom-file-upload.dragover {
        border-color: #6366f1; /* indigo-500 */
        background-color: #334155; /* slate-700 */
      }

      /* Thẻ nhân vật */
      #characterMapContainer .character-profile-card,
      #modal-content .character-profile-card {
        background-color: #1e293b; /* slate-800 */
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid #334155; /* slate-700 */
        position: relative; /* Cho nút xóa */
      }
      #loader {
        border: 5px solid #334155; /* slate-700 */
        border-top: 5px solid #6366f1; /* indigo-500 */
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      #progress-bar-container {
        width: 100%;
        background-color: #334155; /* slate-700 */
        border-radius: 0.5rem;
        overflow: hidden;
        margin-top: 1rem;
      }
      #progress-bar {
        height: 10px;
        width: 0%;
        background-color: #6366f1; /* indigo-500 */
        transition: width 0.3s ease-in-out;
      }

      /* Kiểu cho nút xóa */
      .delete-char-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: none;
        border: none;
        color: #94a3b8; /* slate-400 */
        font-size: 1.1rem;
        cursor: pointer;
        transition: color 0.2s ease;
        padding: 0.25rem;
        line-height: 1;
      }
      .delete-char-btn:hover {
        color: #ef4444; /* red-500 */
      }

      /* Input có thể chỉnh sửa */
      .editable-field {
        background-color: #334155; /* slate-700 */
        border: 1px solid #475569; /* slate-600 */
        border-radius: 0.375rem; /* rounded-md */
        padding: 0.25rem 0.5rem;
        color: #f1f5f9; /* slate-100 */
        width: 100%;
        font-size: 0.875rem; /* text-sm */
      }
      .editable-field:focus {
        outline: 2px solid #6366f1; /* focus:ring-indigo-500 */
        outline-offset: 2px;
        background-color: #475569; /* slate-600 */
      }

      /* Tùy chỉnh thanh cuộn */
      .sub-container,
      #characterMapContainer,
      #modal-content,
      .custom-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: #475569 #1e293b; /* slate-600 slate-800 */
      }
      .sub-container::-webkit-scrollbar,
      #characterMapContainer::-webkit-scrollbar,
      #modal-content::-webkit-scrollbar,
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .sub-container::-webkit-scrollbar-track,
      #characterMapContainer::-webkit-scrollbar-track,
      #modal-content::-webkit-scrollbar-track,
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #1e293b; /* slate-800 */
        border-radius: 10px;
      }
      .sub-container::-webkit-scrollbar-thumb,
      #characterMapContainer::-webkit-scrollbar-thumb,
      #modal-content::-webkit-scrollbar-thumb,
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #475569; /* slate-600 */
        border-radius: 10px;
      }
      .sub-container::-webkit-scrollbar-thumb:hover,
      #characterMapContainer::-webkit-scrollbar-thumb:hover,
      #modal-content::-webkit-scrollbar-thumb:hover,
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #64748b; /* slate-500 */
      }

      /* Khối phụ đề */
      .sub-container {
        height: 70vh;
        max-height: 75vh;
        overflow-y: auto;
        padding: 1rem;
        background-color: #0f172a; /* slate-900 */
        border-radius: 0.75rem; /* rounded-xl */
        transition: height 0.3s ease-in-out;
      }
      .sub-container.expanded {
        height: 85vh; /* Expanded height */
      }
      .sub-block {
        background-color: #1e293b; /* slate-800 */
        border-radius: 0.5rem;
        padding: 0.75rem;
        margin-bottom: 1rem;
        border-left: 3px solid #334155; /* slate-700 */
        transition: background-color 0.2s ease, border-left-color 0.2s ease;
      }
      .sub-block.highlighted {
        background-color: #4338ca; /* indigo-700 */
        border-left-color: #a5b4fc; /* indigo-300 */
      }
      .sub-block.warning-highlight {
        border-left-color: #f59e0b; /* amber-500 */
        background-color: #3f2d15;
      }
      .sub-index {
        font-size: 0.75rem;
        color: #94a3b8; /* slate-400 */
        margin-bottom: 0.25rem;
      }
      .sub-time {
        font-size: 0.8rem;
        color: #cbd5e1; /* slate-300 */
        margin-bottom: 0.5rem;
        font-family: monospace;
      }
      .sub-text {
        color: #f1f5f9; /* slate-100 */
        line-height: 1.6;
        outline: none;
      }

      /* Prose styles for results */
      .prose {
        color: #cbd5e1; /* slate-300 */
        line-height: 1.6;
      }
      .prose h4 {
        color: #ffffff;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }
      .prose-sm {
        font-size: 0.875rem; /* text-sm */
      }
      .prose-invert {
        --tw-prose-body: #cbd5e1;
        --tw-prose-headings: #fff;
      }

      /* Input chung */
      .form-input {
        background-color: #1e293b; /* slate-800 */
        border: 1px solid #334155; /* slate-700 */
        color: #f1f5f9; /* slate-100 */
      }
      .form-input::placeholder {
        color: #64748b; /* slate-500 */
      }
      .form-input:focus {
        border-color: #6366f1; /* indigo-500 */
        ring: 1px;
        box-shadow: 0 0 0 1px #6366f1;
        outline: none;
      }

      /* Suggested titles list */
      #suggested-titles-list li {
        padding: 0.5rem 0;
        border-bottom: 1px solid #334155; /* slate-700 */
        display: flex; /* Cho nút copy */
        justify-content: space-between; /* Đẩy nút copy sang phải */
        align-items: center; /* Căn giữa nút copy */
      }
       #suggested-titles-list li:last-child {
        border-bottom: none;
      }
      /* Nút copy tên truyện */
      .copy-title-btn {
        background: none;
        border: none;
        color: #94a3b8; /* slate-400 */
        cursor: pointer;
        margin-left: 0.75rem; /* Khoảng cách với text */
        transition: color 0.2s ease;
        padding: 0.25rem;
      }
      .copy-title-btn:hover {
        color: #6366f1; /* indigo-500 */
      }
       .copy-title-btn .fa-check { /* Kiểu khi đã copy */
        color: #10b981; /* green-500 */
      }


      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-slate-900 text-slate-200">
    <div class="container mx-auto p-4 md:p-8 max-w-full">
      <!-- Header -->
      <header
        class="flex flex-col items-stretch gap-4 mb-6 pb-4 border-b border-slate-700"
      >
        <div>
          <h1 class="text-3xl font-bold text-white mb-1">
            Trình Dịch Phụ Đề SRT
          </h1>
          <p class="text-md text-slate-400">
            Cung cấp bởi Gemini AI
          </p>
        </div>

        <!-- Bảng Cài Đặt (Mới, có thể thu gọn) -->
        <div
          class="bg-slate-800 rounded-lg border border-slate-700"
        >
          <button
            id="toggle-settings-btn"
            class="flex justify-between items-center w-full p-4"
          >
            <h2 class="text-xl font-bold text-white">
              Bước 1: Cài Đặt & Tải Lên
            </h2>
            <i
              id="settings-chevron"
              class="fas fa-chevron-down text-slate-400 transition-transform"
            ></i>
          </button>
          <!-- Panel nội dung cài đặt -->
          <div
            id="settings-panel"
            class="overflow-hidden transition-all duration-300 ease-in-out"
            style="max-height: 1000px"
          >
            <div class="p-6 pt-0 grid grid-cols-1 md:grid-cols-3 gap-6">
              <!-- Cột 1: Tải Lên -->
              <div class="md:col-span-1 space-y-6">
                <div
                  class="bg-slate-800 rounded-xl"
                >
                  <div class="space-y-6">
                    <div>
                      <h3 class="text-lg font-semibold mb-3 text-white">
                        Tải Lên Tệp
                      </h3>
                      <label
                        for="file-upload"
                        class="custom-file-upload w-full p-8 text-center rounded-lg cursor-pointer block"
                      >
                        <i
                          class="fas fa-file-upload text-4xl text-slate-500 mb-3"
                        ></i>
                        <span id="file-name" class="text-slate-400 text-sm"
                          >Kéo thả hoặc nhấp để tải tệp .srt</span
                        >
                      </label>
                      <input
                        id="file-upload"
                        type="file"
                        accept=".srt"
                        class="hidden"
                      />
                    </div>
                  </div>
                </div>
              </div>
              <!-- Cột 2: API Keys -->
              <div class="md:col-span-1 space-y-6">
                <div
                  class="bg-slate-800 rounded-xl"
                >
                  <div class="space-y-6">
                    <div>
                      <h3 class="text-lg font-semibold mb-3 text-white">
                        API Keys
                      </h3>
                      <div class="space-y-3">
                        <div>
                          <label
                            for="analysisApiKeyInput"
                            class="text-sm font-medium text-slate-300"
                            >Analysis API Key</label
                          >
                          <input
                            type="password"
                            id="analysisApiKeyInput"
                            placeholder="API Key cho Phân tích & Gợi ý"
                            class="mt-1 w-full rounded-md px-3 py-2 text-sm form-input"
                          />
                        </div>
                        <div>
                          <label
                            for="translateApiKeyInput"
                            class="text-sm font-medium text-slate-300"
                            >Translation API Key</label
                          >
                          <input
                            type="password"
                            id="translateApiKeyInput"
                            placeholder="API Key cho Dịch"
                            class="mt-1 w-full rounded-md px-3 py-2 text-sm form-input"
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Cột 3: Thể Loại -->
              <div class="md:col-span-1 space-y-6">
                <div
                  class="bg-slate-800 rounded-xl"
                >
                  <div class="space-y-6">
                    <div>
                      <h3 class="text-lg font-semibold mb-3 text-white">
                        Thể Loại
                      </h3>
                      <select
                        id="genre-select"
                        class="w-full rounded-md px-3 py-2 text-white form-input"
                      >
                        <option value="chung">Chung / Mặc định</option>
                        <option value="tu tiên">Tu tiên / Tiên hiệp</option>
                        <option value="cổ trang">Cổ trang / Lịch sử</option>
                        <option value="hiện đại">Hiện đại</option>
                        <option value="kiếm hiệp">Kiếm hiệp</option>
                        <option value="khoa huyễn">Khoa huyễn (Sci-fi)</option>
                      </select>
                    </div>
                    <!-- Status Div được di chuyển vào đây -->
                    <div id="status" class="mt-4 text-center p-4 text-sm"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Thanh chức năng chính và Pop-up Wrapper -->
        <div id="action-wrapper" class="relative">
          <!-- Thanh chức năng chính -->
          <div
            id="main-action-bar"
            class="bg-slate-800 rounded-lg p-3 flex flex-wrap gap-2 justify-center border border-slate-700"
          >
             <button
              id="suggestTitlesBtn"
              class="flex-1 sm:flex-none bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:bg-slate-600 disabled:cursor-not-allowed text-sm"
              disabled
            >
              <i class="fas fa-lightbulb mr-2"></i> Gợi Ý Tên Truyện
            </button>
            <button
              id="analyzeCharactersBtn"
              class="flex-1 sm:flex-none bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:bg-slate-600 disabled:cursor-not-allowed text-sm"
              disabled
            >
              <i class="fas fa-brain mr-2"></i> P.Tích Nhân Vật
            </button>
            <button
              id="plotAnalysisBtn"
              class="flex-1 sm:flex-none bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:bg-slate-500 disabled:cursor-not-allowed text-sm"
              disabled
            >
              <i class="fas fa-book-open mr-2"></i> P.Tích Cốt Truyện
            </button>
            <button
              id="analyzeRelationshipsBtn"
              class="flex-1 sm:flex-none bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:bg-slate-500 disabled:cursor-not-allowed text-sm"
              disabled
            >
              <i class="fas fa-users mr-2"></i> P.Tích Mối Quan Hệ
            </button>
            <button
              id="translateBtn"
              class="flex-1 sm:flex-none bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:bg-slate-600 disabled:cursor-not-allowed text-sm"
              disabled
            >
              <i class="fas fa-language mr-2"></i> Dịch Ngay
            </button>
          </div>

          <!-- POP-UP HIỂN THỊ KẾT QUẢ PHÂN TÍCH -->
          <div
            id="popup-result-display"
            class="hidden absolute top-full left-0 right-0 z-50 p-6 bg-slate-800 border-t-2 border-indigo-500 rounded-b-lg shadow-lg max-h-[70vh] overflow-y-auto custom-scrollbar"
          >
            <!-- Nội dung sẽ được JS đưa vào đây -->
          </div>
        </div>

        <!-- Thanh công cụ chỉnh sửa (ẩn ban đầu) -->
        <div id="edit-toolbar" class="bg-slate-700 rounded-lg p-4 hidden">
          <h3 class="text-lg font-semibold mb-3">Công Cụ Chỉnh Sửa</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="flex gap-2">
              <input
                type="text"
                id="find-input"
                placeholder="Tìm kiếm..."
                class="flex-grow rounded-md px-3 py-2 text-sm form-input"
              />
              <button
                id="check-chinese-btn"
                class="w-full sm:w-auto bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-4 rounded-lg"
              >
                <i class="fas fa-search"></i>
                <span class="hidden sm:inline ml-2">Rà Soát</span>
              </button>
            </div>
            <div class="flex gap-2">
              <input
                type="password"
                id="retranslateApiKeyInput"
                placeholder="API Key Dịch Lại (Tùy chọn)"
                class="flex-grow rounded-md px-3 py-2 text-sm form-input"
              />
              <button
                id="retranslate-issues-btn"
                class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg hidden"
              >
                <i class="fas fa-sync-alt"></i>
                <span class="hidden sm:inline ml-2">Dịch Lại</span>
              </button>
            </div>
          </div>
          <div id="edit-tool-status" class="text-sm mt-2 text-center"></div>
        </div>

        <div id="downloadBtn-wrapper" class="hidden mt-4 sm:mt-0 self-end">
          <button
            id="headerDownloadBtn"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center shadow-lg"
          >
            <i class="fas fa-download mr-2"></i> Tải Xuống Phụ Đề
          </button>
        </div>
      </header>

      <main class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Cột 1: Cài Đặt (ĐÃ BỊ XÓA, DI CHUYỂN LÊN HEADER) -->
        <!-- <div class="lg:col-span-4 space-y-6"> ... </div> -->

        <!-- Cột 2: Phân Tích (BỊ ẨN ĐI) -->
        <div id="analysis-column" class="lg:col-span-3 hidden">
          <div
            id="analysis-column-content"
            class="bg-slate-800 rounded-xl shadow-lg p-6 space-y-6 border border-slate-700"
          >
             <!-- Section Gợi ý Tên Truyện (Mới) -->
             <div id="title-suggestion-section">
                <h3 class="text-lg font-semibold mb-3 text-white">
                  Gợi Ý Tên Truyện
                </h3>
                <div id="titles-status" class="text-center text-sm my-3"></div>
                <div id="titles-result-container" class="hidden">
                   <ul id="suggested-titles-list" class="list-none mb-4 text-sm text-slate-300">
                      <!-- Title suggestions will be listed here -->
                   </ul>
                   <button
                    id="regenerateTitlesBtn"
                    class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg text-sm"
                    >
                      <i class="fas fa-sync-alt mr-2"></i> Gợi Ý Lại
                   </button>
                </div>
             </div>
            <!-- Phân Tích Nhân Vật -->
            <div id="char-analysis-section">
              <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-semibold text-white">
                  Phân Tích Nhân Vật
                </h3>
                <i
                  id="fullscreen-analysis-btn"
                  class="fas fa-expand-arrows-alt text-slate-400 hover:text-white cursor-pointer hidden"
                  title="Xem toàn màn hình"
                ></i>
              </div>
              <div
                id="analysis-status"
                class="text-center text-sm my-3"
              ></div>
              <div
                id="characterMapContainer"
                class="max-h-60 overflow-y-auto pr-2 custom-scrollbar"
              >
                <!-- Thẻ nhân vật -->
              </div>
            </div>

            <!-- Phân Tích Cốt Truyện -->
            <div
              id="plot-analysis-section"
              class="border-t border-slate-700 pt-6"
            >
              <h3 class="text-lg font-semibold mb-3 text-white">
                Phân Tích Cốt Truyện
              </h3>
              <div
                id="plot-analysis-status"
                class="text-center text-sm my-3"
              ></div>
              <div id="plot-analysis-result-container" class="hidden">
                <div
                  id="plot-analysis-result"
                  class="prose prose-sm prose-invert text-slate-300 bg-slate-900 p-3 rounded-md max-h-40 overflow-y-auto text-xs custom-scrollbar"
                ></div>
              </div>
            </div>

            <!-- Phân Tích Mối Quan Hệ -->
            <div
              id="relationship-analysis-section"
              class="border-t border-slate-700 pt-6"
            >
              <h3 class="text-lg font-semibold mb-3 text-white">
                Phân Tích Mối Quan Hệ
              </h3>
              <div
                id="relationships-status"
                class="text-center text-sm my-3"
              ></div>
              <div id="relationships-result-container" class="hidden">
                <div
                  id="relationships-result"
                  class="prose prose-sm prose-invert text-slate-300 bg-slate-900 p-3 rounded-md max-h-40 overflow-y-auto text-xs custom-scrollbar"
                ></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Cột 3: Kết quả (CHIẾM TOÀN BỘ CHIỀU RỘNG) -->
        <div class="lg:col-span-12">
          <div
            id="loading-container"
            class="hidden flex-col items-center justify-center h-full bg-slate-800 rounded-xl shadow-lg p-6 border border-slate-700"
          >
            <div id="loader"></div>
            <p id="loading-text" class="mt-4 text-lg font-semibold text-white">
              Đang chuẩn bị dịch...
            </p>
            <div id="progress-bar-container"><div id="progress-bar"></div></div>
          </div>

          <div
            id="result-container"
            class="hidden bg-slate-800 rounded-xl shadow-lg p-4 sm:p-6 border border-slate-700"
          >
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-bold text-white">Kết Quả Dịch</h2>
              <i
                id="toggle-size-btn"
                class="fas fa-expand-alt text-slate-400 hover:text-white cursor-pointer"
                title="Phóng to / Thu nhỏ"
              ></i>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <h3
                  class="text-lg font-semibold mb-2 text-center text-slate-300"
                >
                  Gốc (Tiếng Trung)
                </h3>
                <div id="original-sub" class="sub-container"></div>
              </div>
              <div>
                <h3 class="text-lg font-semibold mb-2 text-center text-white">
                  Dịch (Tiếng Việt) - Có thể sửa
                </h3>
                <div id="translated-sub" class="sub-container"></div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Modals -->
    <div
      id="analysis-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4"
    >
      <div
        id="analysis-modal-content-wrapper"
        class="bg-slate-800 rounded-lg shadow-xl w-full max-w-4xl h-[90vh] flex flex-col border border-slate-700"
      >
        <div
          class="flex justify-between items-center p-4 border-b border-slate-700"
        >
          <h2 id="modal-title" class="text-2xl font-bold text-white">
            Bản Phân Tích Nhân Vật Chi Tiết
          </h2>
          <button
            id="close-modal-btn"
            class="text-slate-400 hover:text-white text-3xl font-bold"
          >
            &times;
          </button>
        </div>
        <div
          id="modal-content"
          class="p-6 overflow-y-auto flex-1 min-h-0 custom-scrollbar"
        >
          <!-- Content will be injected here -->
        </div>
      </div>
    </div>

    <script>
      // --- Element selectors ---
      const fileUpload = document.getElementById("file-upload"),
        fileNameDisplay = document.getElementById("file-name");
      const translateBtn = document.getElementById("translateBtn"),
        headerDownloadBtn = document.getElementById("headerDownloadBtn"),
        downloadBtnWrapper = document.getElementById("downloadBtn-wrapper");
      const statusDiv = document.getElementById("status"),
        originalSubDiv = document.getElementById("original-sub"),
        translatedSubDiv = document.getElementById("translated-sub");
      const loadingContainer = document.getElementById("loading-container"),
        loadingText = document.getElementById("loading-text");
      const resultContainer = document.getElementById("result-container"),
        characterMapContainer = document.getElementById(
          "characterMapContainer"
        );
      const analysisApiKeyInput = document.getElementById(
          "analysisApiKeyInput"
        ),
        translateApiKeyInput = document.getElementById("translateApiKeyInput");
      const analyzeCharactersBtn = document.getElementById(
          "analyzeCharactersBtn"
        ),
        analysisStatus = document.getElementById("analysis-status");
      const plotAnalysisBtn = document.getElementById("plotAnalysisBtn"),
        plotAnalysisStatus = document.getElementById("plot-analysis-status"),
        plotAnalysisResultContainer = document.getElementById(
          "plot-analysis-result-container"
        ),
        plotAnalysisResult = document.getElementById("plot-analysis-result");
      const analyzeRelationshipsBtn = document.getElementById(
          "analyzeRelationshipsBtn"
        ),
        relationshipsStatus = document.getElementById("relationships-status"),
        relationshipsResultContainer = document.getElementById(
          "relationships-result-container"
        ),
        relationshipsResult = document.getElementById("relationships-result");
       // NEW: Title Suggestion Elements
      const suggestTitlesBtn = document.getElementById("suggestTitlesBtn"),
            titlesStatus = document.getElementById("titles-status"),
            titlesResultContainer = document.getElementById("titles-result-container"),
            suggestedTitlesList = document.getElementById("suggested-titles-list"),
            regenerateTitlesBtn = document.getElementById("regenerateTitlesBtn");
      const progressBar = document.getElementById("progress-bar");
      const findInput = document.getElementById("find-input");
      const genreSelect = document.getElementById("genre-select");
      const fullscreenBtn = document.getElementById("fullscreen-analysis-btn");
      const analysisModal = document.getElementById("analysis-modal");
      const closeModalBtn = document.getElementById("close-modal-btn");
      const modalContent = document.getElementById("modal-content");
      const modalTitle = document.getElementById("modal-title");
      const toggleSizeBtn = document.getElementById("toggle-size-btn");
      const checkChineseBtn = document.getElementById("check-chinese-btn");
      const editToolStatus = document.getElementById("edit-tool-status");
      const editToolbar = document.getElementById("edit-toolbar");
      const retranslateIssuesBtn = document.getElementById(
        "retranslate-issues-btn"
      );
      const retranslateApiKeyInput = document.getElementById(
        "retranslateApiKeyInput"
      );

      // --- NEW POPUP SELECTORS ---
      const actionWrapper = document.getElementById("action-wrapper");
      const popupResultDisplay = document.getElementById(
        "popup-result-display"
      );
      const analysisColumnContent = document.getElementById(
        "analysis-column-content"
      );
      const charAnalysisSection = document.getElementById(
        "char-analysis-section"
      );
      const plotAnalysisSection = document.getElementById(
        "plot-analysis-section"
      );
      const relationshipAnalysisSection = document.getElementById(
        "relationship-analysis-section"
      );
      // NEW: Title Suggestion Section for Popup
      const titleSuggestionSection = document.getElementById("title-suggestion-section");


      // --- NEW SETTINGS TOGGLE SELECTORS ---
      const toggleSettingsBtn = document.getElementById("toggle-settings-btn");
      const settingsPanel = document.getElementById("settings-panel");
      const settingsChevron = document.getElementById("settings-chevron");

      // --- State variables ---
      let originalSrtContent = "",
        translatedSrtContent = "",
        originalFileName = "";
      let parsedSubs = [],
        translatedParsedSubs = [];
      let userAnalysisApiKey = "",
        userTranslateApiKey = "";
      let plotAnalysisContext = "";
      let relationshipContext = "";
      let untranslatedIndices = [];

      // --- NEW POPUP STATE ---
      let activePopup = null;
      let hidePopupTimer = null;

      // --- Event Listeners ---
      analysisApiKeyInput.addEventListener("input", (e) => {
        userAnalysisApiKey = e.target.value.trim();
        localStorage.setItem("analysisApiKey", userAnalysisApiKey);
      });
      translateApiKeyInput.addEventListener("input", (e) => {
        userTranslateApiKey = e.target.value.trim();
        localStorage.setItem("translateApiKey", userTranslateApiKey);
      });
      fileUpload.addEventListener("change", handleFileSelect);
      const fileLabel = fileUpload.previousElementSibling;
      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) =>
        fileLabel.addEventListener(
          eventName,
          (e) => {
            e.preventDefault();
            e.stopPropagation();
          },
          false
        )
      );
      ["dragenter", "dragover"].forEach((eventName) =>
        fileLabel.addEventListener(
          eventName,
          () => fileLabel.classList.add("dragover"),
          false
        )
      );
      ["dragleave", "drop"].forEach((eventName) =>
        fileLabel.addEventListener(
          eventName,
          () => fileLabel.classList.remove("dragover"),
          false
        )
      );
      fileLabel.addEventListener("drop", handleDrop, false);

      analyzeCharactersBtn.addEventListener("click", runCharacterAnalysis);
      plotAnalysisBtn.addEventListener("click", runPlotAnalysis);
      analyzeRelationshipsBtn.addEventListener(
        "click",
        runRelationshipAnalysis
      );
      // NEW: Title Suggestion Listeners
      suggestTitlesBtn.addEventListener("click", runSuggestTitles);
      regenerateTitlesBtn.addEventListener("click", runSuggestTitles);

      translateBtn.addEventListener("click", runTranslation);
      retranslateIssuesBtn.addEventListener("click", retranslateIssues);

      // Listen for dynamic delete buttons
      characterMapContainer.addEventListener("click", function (e) {
        const deleteButton = e.target.closest(".delete-char-btn");
        if (deleteButton) {
          deleteButton.closest(".character-profile-card").remove();
        }
      });
       // NEW: Listen for dynamic copy buttons in title list
        suggestedTitlesList.addEventListener('click', function(e) {
            const copyButton = e.target.closest('.copy-title-btn');
            if (copyButton) {
                // Find the span containing the title text within the same list item
                const titleSpan = copyButton.closest('li').querySelector('span');
                if (titleSpan) {
                    const titleText = titleSpan.textContent;
                     copyToClipboard(titleText, copyButton);
                }
            }
        });


      translatedSubDiv.addEventListener("input", (e) => {
        if (e.target.classList.contains("sub-text")) {
          const arrayIndex = parseInt(e.target.dataset.arrayIndex, 10);
          if (!isNaN(arrayIndex) && translatedParsedSubs[arrayIndex]) {
            translatedParsedSubs[arrayIndex].text = e.target.textContent;
            translatedSrtContent = buildSRT(translatedParsedSubs);
          }
        }
      });
      translatedSubDiv.addEventListener("focusin", (e) => {
        if (e.target.classList.contains("sub-text")) {
          document
            .querySelectorAll(".sub-block.highlighted")
            .forEach((el) => el.classList.remove("highlighted"));
          const arrayIndex = e.target.dataset.arrayIndex;
          const originalBlock = document.getElementById(
            `original-sub-block-${arrayIndex}`
          );
          const translatedBlock = e.target.closest(".sub-block");
          if (originalBlock) {
            originalBlock.classList.add("highlighted");
            originalBlock.scrollIntoView({
              behavior: "smooth",
              block: "center",
            });
          }
          if (translatedBlock) translatedBlock.classList.add("highlighted");
        }
      });
      checkChineseBtn.addEventListener("click", checkRemainingChinese);
      headerDownloadBtn.addEventListener("click", downloadSRT);
      fullscreenBtn.addEventListener("click", () =>
        showModalWithContent("analysis")
      );
      closeModalBtn.addEventListener("click", hideAnalysisModal);
      analysisModal.addEventListener("click", (e) => {
        if (e.target.id === "analysis-modal") {
          hideAnalysisModal();
        }
      });
      toggleSizeBtn.addEventListener("click", () => {
        const isExpanded = originalSubDiv.classList.contains("expanded");
        originalSubDiv.classList.toggle("expanded");
        translatedSubDiv.classList.toggle("expanded");
        if (isExpanded) {
          toggleSizeBtn.classList.remove("fa-compress-alt");
          toggleSizeBtn.classList.add("fa-expand-alt");
          toggleSizeBtn.title = "Phóng to";
        } else {
          toggleSizeBtn.classList.remove("fa-expand-alt");
          toggleSizeBtn.classList.add("fa-compress-alt");
          toggleSizeBtn.title = "Thu nhỏ";
        }
      });

      // --- NEW SETTINGS TOGGLE LISTENER ---
      toggleSettingsBtn.addEventListener("click", () => {
        if (
          settingsPanel.style.maxHeight &&
          settingsPanel.style.maxHeight !== "0px"
        ) {
          settingsPanel.style.maxHeight = "0px";
          settingsPanel.classList.add("pt-0"); // Ẩn padding khi đóng
        } else {
          settingsPanel.style.maxHeight = settingsPanel.scrollHeight + "px";
          settingsPanel.classList.remove("pt-0"); // Hiển thị lại padding
        }
        settingsChevron.classList.toggle("rotate-180");
      });

      // --- NEW POPUP LOGIC FUNCTIONS ---
      function showPopup(contentElement) {
        clearTimeout(hidePopupTimer);
        if (activePopup === contentElement) return; // Đã hiển thị, không làm gì

        // Ẩn pop-up cũ nếu có
        if (activePopup) {
          activePopup.classList.add("hidden");
          analysisColumnContent.appendChild(activePopup); // Trả về kho chứa ẩn
        }

        activePopup = contentElement;
        popupResultDisplay.appendChild(contentElement); // Di chuyển element vào pop-up
        contentElement.classList.remove("hidden"); // Hiển thị section
        popupResultDisplay.classList.remove("hidden"); // Hiển thị pop-up
      }

      function startHideTimer() {
        clearTimeout(hidePopupTimer);
        hidePopupTimer = setTimeout(() => {
          if (activePopup) {
            activePopup.classList.add("hidden");
            analysisColumnContent.appendChild(activePopup); // Trả về kho chứa ẩn
            activePopup = null;
            popupResultDisplay.classList.add("hidden");
          }
        }, 300); // Đợi 300ms
      }

      // --- NEW POPUP EVENT LISTENERS ---
      actionWrapper.addEventListener("mouseleave", startHideTimer);
      popupResultDisplay.addEventListener("mouseenter", () =>
        clearTimeout(hidePopupTimer)
      ); // Hủy ẩn nếu di chuột vào pop-up

      // NEW: Title Suggestion Hover
      suggestTitlesBtn.addEventListener("mouseenter", () => showPopup(titleSuggestionSection));

      analyzeCharactersBtn.addEventListener("mouseenter", () =>
        showPopup(charAnalysisSection)
      );
      plotAnalysisBtn.addEventListener("mouseenter", () =>
        showPopup(plotAnalysisSection)
      );
      analyzeRelationshipsBtn.addEventListener("mouseenter", () =>
        showPopup(relationshipAnalysisSection)
      );
      // Nút dịch không cần hover
      translateBtn.addEventListener("mouseenter", () =>
        clearTimeout(hidePopupTimer)
      );

      // --- Load API Keys on Startup ---
      function loadApiKeys() {
        const savedAnalysisKey = localStorage.getItem("analysisApiKey");
        if (savedAnalysisKey) {
          analysisApiKeyInput.value = savedAnalysisKey;
          userAnalysisApiKey = savedAnalysisKey;
        }
        const savedTranslateKey = localStorage.getItem("translateApiKey");
        if (savedTranslateKey) {
          translateApiKeyInput.value = savedTranslateKey;
          userTranslateApiKey = savedTranslateKey;
        }
      }
      loadApiKeys(); // Call on script load

      function handleDrop(e) {
        if (e.dataTransfer.files.length > 0) {
          fileUpload.files = e.dataTransfer.files;
          handleFileSelect({ target: fileUpload });
        }
      }

      function handleFileSelect(event) {
        const file = event.target.files[0];
        // Reset mọi thứ
        characterMapContainer.innerHTML = "";
        analysisStatus.textContent = "";
        plotAnalysisStatus.textContent = "";
        plotAnalysisResultContainer.classList.add("hidden");
        relationshipsStatus.textContent = "";
        relationshipsResultContainer.classList.add("hidden");
        // NEW: Reset Title Suggestions
        titlesStatus.textContent = "";
        titlesResultContainer.classList.add("hidden");
        suggestedTitlesList.innerHTML = "";

        fullscreenBtn.classList.add("hidden");
        plotAnalysisContext = "";
        relationshipContext = "";
        downloadBtnWrapper.classList.add("hidden");
        editToolbar.classList.add("hidden");
        resultContainer.classList.add("hidden");
        loadingContainer.classList.add("hidden");
        statusDiv.textContent = "";

        // Ẩn các section trong cột phân tích (dù cột đã ẩn)
        titleSuggestionSection.classList.add("hidden"); // NEW
        charAnalysisSection.classList.add("hidden");
        plotAnalysisSection.classList.add("hidden");
        relationshipAnalysisSection.classList.add("hidden");

        if (file && file.name.endsWith(".srt")) {
          originalFileName = file.name.replace(".srt", "");
          fileNameDisplay.textContent = file.name;
          fileNameDisplay.classList.add("text-green-400");
          [analyzeCharactersBtn, plotAnalysisBtn, suggestTitlesBtn].forEach( // NEW: Enable suggestTitlesBtn
            (btn) => (btn.disabled = false)
          );
          analyzeRelationshipsBtn.disabled = true; // Vẫn tắt cho đến khi Bước 2 chạy
          translateBtn.disabled = true; // Vẫn tắt cho đến khi Bước 2 chạy

          const reader = new FileReader();
          reader.onload = (e) => {
            originalSrtContent = e.target.result;
            parsedSubs = parseSRT(originalSrtContent);
            displaySubtitles(parsedSubs, originalSubDiv);
          };
          reader.readAsText(file);
        } else {
          fileNameDisplay.textContent = "Kéo thả hoặc nhấp để tải tệp .srt";
          fileNameDisplay.classList.remove("text-green-400");
          [
            translateBtn,
            analyzeCharactersBtn,
            plotAnalysisBtn,
            analyzeRelationshipsBtn,
            suggestTitlesBtn // NEW
          ].forEach((btn) => (btn.disabled = true));
          originalFileName = "";
          originalSrtContent = "";
          parsedSubs = [];
        }
      }

      // --- Modal Logic ---
      function showModalWithContent(type) {
        if (type === "analysis") {
          if (characterMapContainer.innerHTML.trim() === "") {
            analysisStatus.textContent = "Chưa có phân tích nào để hiển thị.";
            analysisStatus.className = "text-yellow-400";
            return;
          }
          modalTitle.textContent = "Bản Phân Tích Nhân Vật Chi Tiết";
          const clonedContent = characterMapContainer.cloneNode(true);
          clonedContent.classList.remove(
            "max-h-60",
            "overflow-y-auto",
            "pr-2"
          );
          modalContent.innerHTML = "";
          modalContent.appendChild(clonedContent);
          modalContent.classList.remove("modal-prose");
        }
        analysisModal.classList.remove("hidden");
      }

      function hideAnalysisModal() {
        analysisModal.classList.add("hidden");
      }

      // --- Character Profile Logic ---
      function getCharacterContext() {
        const entries = characterMapContainer.querySelectorAll(
          ".character-profile-card"
        );
        if (entries.length === 0) return "";
        let contextText =
          "BỐI CẢNH NHÂN VẬT (CỰC KỲ QUAN TRỌNG, HÃY TUÂN THỦ NGHIÊM NGẶT):\n";
        entries.forEach((entry) => {
          const originalName = entry
            .querySelector(".original-name-display")
            .textContent.split(":")[0]
            .trim();
          const phoneticName = entry
            .querySelector(".original-name-display")
            .textContent.split(":")[1]
            .trim();
          const gender = entry.querySelector(".gender-input").value.trim();
          const age = entry.querySelector(".age-input").value.trim();
          const translationRule = entry
            .querySelector(".translation-rule-input")
            .value.trim();

          if (originalName && translationRule) {
            let info = `Tên: ${originalName} (Phiên âm: ${phoneticName})`;
            if (gender) info += `, Giới tính: ${gender}`;
            if (age) info += `, Tuổi: ${age}`;

            contextText += `\n- NHÂN VẬT: ${info}\n  - QUY TẮC DỊCH TÊN/XƯNG HÔ CHÍNH: ${translationRule}\n`;
          }
        });
        return contextText;
      }

      async function runCharacterAnalysis() {
        if (parsedSubs.length === 0)
          throw new Error("Vui lòng tải tệp SRT trước.");

        analysisStatus.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Đang phân tích, vui lòng chờ...`;
        analysisStatus.className =
          "text-blue-400 flex items-center justify-center";
        analyzeCharactersBtn.disabled = true;
        analyzeRelationshipsBtn.disabled = true; // Tắt khi đang chạy
        translateBtn.disabled = true; // Tắt khi đang chạy

        // Hiển thị section (dù nó đang ở trong cột ẩn) để logic hover hoạt động
        charAnalysisSection.classList.remove("hidden");

        try {
          const sampleText = parsedSubs
            .slice(0, Math.min(parsedSubs.length, 300))
            .map((sub) => sub.text)
            .join("\n");
          const characters = await analyzeCharactersWithAI(sampleText);

          characterMapContainer.innerHTML = "";
          if (characters.length === 0) {
            analysisStatus.textContent = "Không tìm thấy nhân vật nào đáng kể.";
            analysisStatus.className = "text-gray-400";
          } else {
            characters.forEach((char) => {
              const entry = document.createElement("div");
              entry.className = "character-profile-card";
              entry.innerHTML = `
                <button class="delete-char-btn" title="Xóa nhân vật">
                  <i class="fas fa-trash-alt" style="pointer-events: none;"></i>
                </button>
                <h4 class="original-name-display text-lg font-bold text-white mb-2">${
                  char.full_chinese_name
                }: ${char.vietnamese_phonetic_name}</h4>
                <div class="grid grid-cols-2 gap-2 mb-3">
                  <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1">Giới tính</label>
                    <input type="text" value="${
                      char.gender
                    }" class="gender-input editable-field" placeholder="Nam/Nữ...">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1">Tuổi</label>
                    <input type="text" value="${
                      char.estimated_age
                    }" class="age-input editable-field" placeholder="Tuổi...">
                  </div>
                </div>
                <div>
                  <label class="block text-xs font-medium text-slate-400 mb-1">Quy tắc dịch tên/xưng hô</label>
                  <input type="text" value="${
                    char.vietnamese_phonetic_name
                  }" placeholder="Nhập quy tắc dịch/xưng hô..." class="translation-rule-input editable-field">
                </div>
              `;
              characterMapContainer.appendChild(entry);
            });
            analysisStatus.textContent = `Phân tích xong! Đã tìm thấy ${characters.length} nhân vật.`;
            analysisStatus.className = "text-green-500";
            fullscreenBtn.classList.remove("hidden");
            translateBtn.disabled = false; // Bật Dịch
            analyzeRelationshipsBtn.disabled = false; // Bật Phân tích Mối quan hệ
          }
        } catch (error) {
          console.error("Lỗi phân tích nhân vật:", error);
          analysisStatus.textContent = `Lỗi: ${error.message}`;
          analysisStatus.className = "text-red-500";
          throw error;
        } finally {
          analyzeCharactersBtn.disabled = false;
        }
      }

      async function analyzeCharactersWithAI(text) {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${
          userAnalysisApiKey || ""
        }`;
        const systemPrompt = `Bạn là một chuyên gia phân tích kịch bản. Nhiệm vụ của bạn là đọc phụ đề và trích xuất TOÀN BỘ các nhân vật.
1. ƯU TIÊN HÀNG ĐẦU: Chỉ lấy những nhân vật có "Họ và Tên Đầy Đủ" (ví dụ: 'Lý Mộ Bạch', 'Trương Vô Kỵ').
2. BỎ QUA: Bỏ qua các danh xưng, biệt hiệu (ví dụ: 'bạch nguyệt quang', 'sư phụ') hoặc các tên không đầy đủ, tên chỉ có 1 chữ.
3. NGOẠI LỆ QUAN TRỌNG: Nếu phát hiện có "nhân vật tôi" (người kể chuyện, xưng '我'), HÃY THÊM nhân vật đó vào danh sách với tên 'Nhân vật tôi' hoặc 'Người kể chuyện', và cố gắng suy đoán giới tính, độ tuổi.`;

        const userPrompt = `Phân tích các nhân vật trong phụ đề sau. Chỉ lấy nhân vật có HỌ TÊN ĐẦY ĐỦ (hoặc "Nhân vật tôi"). Với mỗi nhân vật, cung cấp các mục sau:\n1. 'full_chinese_name': Tên đầy đủ tiếng Trung (hoặc '我' nếu là người kể chuyện).\n2. 'vietnamese_phonetic_name': Tên phiên âm Hán-Việt (hoặc 'Nhân vật tôi').\n3. 'gender': Giới tính (suy đoán nếu có thể).\n4. 'estimated_age': Tuổi ước tính (suy đoán nếu có thể).\n\nPhụ đề:\n\n${text}`;

        const payload = {
          contents: [{ parts: [{ text: userPrompt }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: {
            responseMimeType: "application/json",
            responseSchema: {
              type: "ARRAY",
              items: {
                type: "OBJECT",
                properties: {
                  full_chinese_name: { type: "STRING" },
                  vietnamese_phonetic_name: { type: "STRING" },
                  gender: { type: "STRING" },
                  estimated_age: { type: "STRING" },
                },
                required: [
                  "full_chinese_name",
                  "vietnamese_phonetic_name",
                  "gender",
                  "estimated_age",
                ],
              },
            },
          },
          safetySettings: [
            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
            {
              category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
              threshold: "BLOCK_NONE",
            },
            {
              category: "HARM_CATEGORY_DANGEROUS_CONTENT",
              threshold: "BLOCK_NONE",
            },
          ],
        };
        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!response.ok)
          throw new Error(
            `Lỗi API phân tích: ${response.status} ${await response.text()}`
          );
        const result = await response.json();
        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!jsonText) throw new Error("Phản hồi AI không chứa JSON.");
        return JSON.parse(jsonText);
      }

      // --- Plot Analysis ---
      async function runPlotAnalysis() {
        if (parsedSubs.length === 0) {
          plotAnalysisStatus.textContent = "Vui lòng tải tệp SRT trước.";
          plotAnalysisStatus.className = "text-yellow-400";
          return;
        }
        plotAnalysisStatus.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Đang phân tích cốt truyện...`;
        plotAnalysisStatus.className =
          "text-blue-400 flex items-center justify-center";
        plotAnalysisBtn.disabled = true;
        plotAnalysisContext = ""; // Reset context

        // Hiển thị section (dù nó đang ở trong cột ẩn) để logic hover hoạt động
        plotAnalysisSection.classList.remove("hidden");

        try {
          const fullText = parsedSubs.map((sub) => sub.text).join("\n");
          const analysisResult = await analyzePlotWithAI(fullText);

          plotAnalysisContext = analysisResult; // Lưu kết quả để dùng khi dịch
          plotAnalysisResult.textContent = analysisResult;
          plotAnalysisResultContainer.classList.remove("hidden"); // HIỂN THỊ CONTAINER BÊN TRONG
          plotAnalysisStatus.textContent = "Phân tích cốt truyện hoàn tất.";
          plotAnalysisStatus.className = "text-green-500";
        } catch (error) {
          console.error("Lỗi phân tích cốt truyện:", error);
          plotAnalysisStatus.textContent = `Lỗi: ${error.message}`;
          plotAnalysisStatus.className = "text-red-500";
        } finally {
          plotAnalysisBtn.disabled = false;
        }
      }

      async function analyzePlotWithAI(text) {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${
          userAnalysisApiKey || ""
        }`;
        const systemPrompt = `Bạn là một biên tập viên kịch bản. Nhiệm vụ của bạn là đọc toàn bộ phụ đề và đưa ra nhận định ngắn gọn xem cốt truyện đã kết thúc trọn vẹn hay còn bỏ ngỏ, có khả năng có phần tiếp theo.`;
        const userPrompt = `Dựa vào toàn bộ nội dung phụ đề dưới đây, hãy cho biết cốt truyện đã kết thúc trọn vẹn chưa hay còn bỏ ngỏ (có khả năng có phần 2)?\n\nPhụ đề:\n${text.substring(
          0,
          50000
        )}... (trích đoạn toàn bộ phụ đề)`;

        const payload = {
          contents: [{ parts: [{ text: userPrompt }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: { temperature: 0.3 },
          safetySettings: [
            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
            {
              category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
              threshold: "BLOCK_NONE",
            },
            {
              category: "HARM_CATEGORY_DANGEROUS_CONTENT",
              threshold: "BLOCK_NONE",
            },
          ],
        };
        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!response.ok)
          throw new Error(
            `Lỗi API phân tích cốt truyện: ${
              response.status
            } ${await response.text()}`
          );
        const result = await response.json();
        const candidate = result.candidates?.[0];
        if (candidate && candidate.content?.parts?.[0]?.text) {
          return candidate.content.parts[0].text;
        } else {
          throw new Error("Phản hồi AI không hợp lệ.");
        }
      }

      // --- Relationship Analysis ---
      function getCharacterListForAnalysis() {
        const entries = characterMapContainer.querySelectorAll(
          ".character-profile-card"
        );
        if (entries.length === 0) return "Chưa có nhân vật nào được phân tích.";

        let listText = "DANH SÁCH NHÂN VẬT ĐÃ BIẾT:\n";
        entries.forEach((entry) => {
          const originalName = entry
            .querySelector(".original-name-display")
            .textContent.split(":")[0]
            .trim();
          const phoneticName = entry
            .querySelector(".original-name-display")
            .textContent.split(":")[1]
            .trim();
          const gender =
            entry.querySelector(".gender-input").value.trim() || "Không rõ";
          const age =
            entry.querySelector(".age-input").value.trim() || "Không rõ";

          listText += `- Tên: ${originalName} (Phiên âm: ${phoneticName}), Giới tính: ${gender}, Tuổi: ${age}\n`;
        });
        return listText;
      }

      async function runRelationshipAnalysis() {
        if (parsedSubs.length === 0) {
          relationshipsStatus.textContent = "Vui lòng tải tệp SRT trước.";
          relationshipsStatus.className = "text-yellow-400";
          return;
        }
        if (characterMapContainer.innerHTML.trim() === "") {
          relationshipsStatus.textContent =
            "Vui lòng chạy 'Phân Tích Nhân Vật' trước.";
          relationshipsStatus.className = "text-yellow-400";
          return;
        }

        relationshipsStatus.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Đang phân tích mối quan hệ...`;
        relationshipsStatus.className =
          "text-blue-400 flex items-center justify-center";
        analyzeRelationshipsBtn.disabled = true;
        relationshipContext = ""; // Reset context

        // Hiển thị section (dù nó đang ở trong cột ẩn) để logic hover hoạt động
        relationshipAnalysisSection.classList.remove("hidden");

        try {
          const characterList = getCharacterListForAnalysis();
          const fullSrtText = parsedSubs.map((sub) => sub.text).join("\n");

          const analysisResult = await analyzeRelationshipsWithAI(
            characterList,
            fullSrtText
          );

          relationshipContext = analysisResult; // Store for translation
          relationshipsResult.innerHTML = analysisResult.replace(/\n/g, "<br>");
          relationshipsResultContainer.classList.remove("hidden"); // HIỂN THỊ CONTAINER BÊN TRONG
          relationshipsStatus.textContent = "Phân tích mối quan hệ hoàn tất.";
          relationshipsStatus.className = "text-green-500";
        } catch (error) {
          console.error("Lỗi phân tích mối quan hệ:", error);
          relationshipsStatus.textContent = `Lỗi: ${error.message}`;
          relationshipsStatus.className = "text-red-500";
        } finally {
          analyzeRelationshipsBtn.disabled = false;
        }
      }

      async function analyzeRelationshipsWithAI(characterList, fullSrtText) {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${
          userAnalysisApiKey || ""
        }`;

        // **** MODIFIED PROMPT ****
        const systemPrompt = `Bạn là một chuyên gia phân tích kịch bản, hiểu rõ về văn hóa và cách xưng hô của người Trung Quốc.
Nhiệm vụ của bạn là đọc danh sách nhân vật (cùng tuổi và giới tính) và toàn bộ lời thoại của kịch bản (tiếng Trung).
Sau đó, hãy phân tích mối quan hệ giữa các nhân vật chính VÀ gợi ý cách họ gọi nhau bằng tiếng Trung (sử dụng Pinyin).
Hãy trình bày kết quả một cách ngắn gọn, rõ ràng.`;

        const userPrompt = `Dựa trên danh sách nhân vật và toàn bộ lời thoại dưới đây, hãy phân tích mối quan hệ và gợi ý cách xưng hô tiếng Trung (Pinyin) cho họ.

${characterList}

---
TOÀN BỘ LỜI THOẠI (để phân tích bối cảnh):
${fullSrtText.substring(0, 50000)}... (trích đoạn)
---

Hãy trả về kết quả phân tích của bạn dưới dạng văn bản thuần túy, ví dụ:
- A (Nam, 30) và B (Nữ, 28): Người yêu. A gọi B là 'Bǎobèi'. B gọi A là 'Lǎogōng'.
- C (Nam, 55) là cha của A: A gọi C là 'Bàba'. C gọi A là 'Érzi'.`;
        // **** END OF MODIFICATION ****

        const payload = {
          contents: [{ parts: [{ text: userPrompt }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: { temperature: 0.3 },
          safetySettings: [
            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
            {
              category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
              threshold: "BLOCK_NONE",
            },
            {
              category: "HARM_CATEGORY_DANGEROUS_CONTENT",
              threshold: "BLOCK_NONE",
            },
          ],
        };

        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(
            `Lỗi API phân tích MQH: ${
              response.status
            } ${await response.text()}`
          );
        }
        const result = await response.json();
        const candidate = result.candidates?.[0];
        if (candidate && candidate.content?.parts?.[0]?.text) {
          return candidate.content.parts[0].text;
        } else {
          throw new Error("Phản hồi AI không hợp lệ.");
        }
      }

      // --- NEW: Title Suggestion Logic ---
      async function runSuggestTitles() {
        if (parsedSubs.length === 0) {
          titlesStatus.textContent = "Vui lòng tải tệp SRT trước.";
          titlesStatus.className = "text-yellow-400";
          return;
        }
        titlesStatus.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Đang tìm gợi ý tên truyện...`;
        titlesStatus.className = "text-blue-400 flex items-center justify-center";
        suggestTitlesBtn.disabled = true;
        regenerateTitlesBtn.disabled = true;

        // Ensure the section is visible for the popup logic
        titleSuggestionSection.classList.remove("hidden");

        try {
            const srtSampleText = parsedSubs.slice(0, Math.min(parsedSubs.length, 300)) // Sample first 300 lines
                                    .map(sub => sub.text)
                                    .join("\n");
            const suggestedTitles = await suggestTitlesWithAI(srtSampleText);

            suggestedTitlesList.innerHTML = ""; // Clear previous list
            if (suggestedTitles && suggestedTitles.length > 0) {
                suggestedTitles.forEach(title => {
                    const li = document.createElement("li");
                    const span = document.createElement("span"); // Span to hold text
                    span.textContent = title;
                    const button = document.createElement("button");
                    button.className = "copy-title-btn";
                    button.innerHTML = '<i class="fas fa-copy"></i>';
                    button.title = "Sao chép tên";

                    li.appendChild(span);
                    li.appendChild(button);
                    suggestedTitlesList.appendChild(li);
                });
                titlesResultContainer.classList.remove("hidden");
                titlesStatus.textContent = "Đã tìm thấy 10 gợi ý tên truyện:";
                titlesStatus.className = "text-green-500";
            } else {
                titlesStatus.textContent = "Không thể tạo gợi ý tên truyện.";
                titlesStatus.className = "text-yellow-400";
                titlesResultContainer.classList.add("hidden");
            }

        } catch (error) {
            console.error("Lỗi gợi ý tên truyện:", error);
            titlesStatus.textContent = `Lỗi: ${error.message}`;
            titlesStatus.className = "text-red-500";
        } finally {
            suggestTitlesBtn.disabled = false;
            regenerateTitlesBtn.disabled = false;
        }
      }

      async function suggestTitlesWithAI(srtContent) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userAnalysisApiKey || ""}`;
            const systemPrompt = "Bạn là một biên tập viên sáng tạo. Nhiệm vụ của bạn là đọc tóm tắt hoặc trích đoạn nội dung của một câu chuyện (từ phụ đề) và gợi ý 10 tên truyện bằng tiếng Việt thật hấp dẫn, ngắn gọn và phù hợp với nội dung.";
            const userPrompt = `Dựa vào nội dung phụ đề dưới đây, hãy gợi ý 10 tên truyện bằng tiếng Việt. Mỗi tên truyện cần ngắn gọn, hấp dẫn và phản ánh được nội dung chính hoặc không khí của câu chuyện.\n\nNội dung phụ đề (trích đoạn):\n${srtContent}\n\nHãy trả về kết quả dưới dạng một mảng JSON chỉ chứa các chuỗi tên truyện (ví dụ: ["Tên truyện 1", "Tên truyện 2", ..., "Tên truyện 10"]).`;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: { type: "STRING" }
                    },
                    temperature: 0.7 // Tăng nhiệt độ để có gợi ý sáng tạo hơn
                },
                safetySettings: [
                  { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                  { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                  { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                  { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                ],
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Lỗi API gợi ý tên: ${response.status} ${await response.text()}`);
            }
            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!jsonText) {
                throw new Error("Phản hồi AI không chứa danh sách tên truyện.");
            }
            try {
                return JSON.parse(jsonText);
            } catch (e) {
                console.error("Lỗi phân tích JSON tên truyện:", e, "Raw:", jsonText);
                throw new Error("Phản hồi AI không phải là JSON hợp lệ.");
            }
        }

       // --- NEW: Copy to Clipboard Function ---
        function copyToClipboard(text, buttonElement) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                // Visual feedback
                const originalIcon = buttonElement.innerHTML;
                buttonElement.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    buttonElement.innerHTML = originalIcon;
                }, 1500); // Reset icon after 1.5 seconds
            } catch (err) {
                console.error('Không thể sao chép:', err);
                // Optionally show an error message to the user
            }
            document.body.removeChild(textarea);
        }


      // --- SRT Utilities ---
      function parseSRT(data) {
        return data
          .replace(/\r/g, "")
          .split("\n\n")
          .filter(Boolean)
          .map((block) => {
            const lines = block.split("\n");
            return lines.length >= 3
              ? {
                  index: lines[0],
                  time: lines[1],
                  text: lines.slice(2).join("\n"),
                }
              : null;
          })
          .filter(Boolean);
      }
      function buildSRT(subs) {
        return subs
          .map((sub) => `${sub.index}\n${sub.time}\n${sub.text}`)
          .join("\n\n");
      }

      function displaySubtitles(subs, element, isEditable = false) {
        element.innerHTML = ""; // Clear previous content
        subs.forEach((sub, i) => {
          const block = document.createElement("div");
          block.id = `${element.id}-block-${i}`;
          block.className = "sub-block";
          const indexEl = document.createElement("div");
          indexEl.className = "sub-index";
          indexEl.textContent = sub.index;
          const timeEl = document.createElement("div");
          timeEl.className = "sub-time";
          timeEl.textContent = sub.time;
          const textEl = document.createElement("div");
          textEl.className = "sub-text";
          textEl.textContent = sub.text;
          if (isEditable) {
            textEl.contentEditable = true;
            textEl.dataset.arrayIndex = i;
          }
          block.append(indexEl, timeEl, textEl);
          element.appendChild(block);
        });
      }

      // --- Translation & Editing ---
      async function runTranslation() {
        if (parsedSubs.length === 0)
          throw new Error("Không có nội dung để dịch.");
        if (characterMapContainer.innerHTML.trim() === "") {
          statusDiv.textContent =
            "Lỗi: Bạn phải chạy 'Phân Tích Nhân Vật' trước khi dịch.";
          statusDiv.className = "text-red-500";
          return;
        }

        translateBtn.disabled = true;
        resultContainer.classList.add("hidden");
        loadingContainer.classList.remove("hidden");
        loadingContainer.classList.add("flex");
        statusDiv.textContent = "";
        translatedSubDiv.innerHTML = "";
        progressBar.style.width = "0%";

        const CHUNK_SIZE = 30;
        const characterContext = getCharacterContext();
        const selectedGenre = genreSelect.value;
        const plotContextForTranslation = plotAnalysisContext; // Lấy bối cảnh cốt truyện
        const relationshipContextForTranslation = relationshipContext; // Lấy bối cảnh mối quan hệ
        translatedParsedSubs = [];
        let previousChunkContext = "";
        const totalChunks = Math.ceil(parsedSubs.length / CHUNK_SIZE);

        try {
          for (let i = 0; i < parsedSubs.length; i += CHUNK_SIZE) {
            const chunkIndex = Math.floor(i / CHUNK_SIZE) + 1;
            loadingText.textContent = `Đang dịch khối ${chunkIndex} / ${totalChunks}...`;
            progressBar.style.width = `${(chunkIndex / totalChunks) * 100}%`;
            const chunk = parsedSubs.slice(i, i + CHUNK_SIZE);
            const textToTranslate = chunk
              .map((sub, index) => `${index + 1}:: ${sub.text}`)
              .join("\n---\n");

            let translatedText = "";
            let attempt = 0;
            const MAX_ATTEMPTS = 3;
            let isValidResponse = false;

            while (attempt < MAX_ATTEMPTS && !isValidResponse) {
              attempt++;
              try {
                translatedText = await callTranslationAPI(
                  textToTranslate,
                  characterContext,
                  selectedGenre,
                  previousChunkContext,
                  plotContextForTranslation, // Truyền bối cảnh cốt truyện
                  relationshipContextForTranslation // Truyền bối cảnh mối quan hệ
                );
                const translatedMap = new Map();
                translatedText.split("\n---\n").forEach((block) => {
                  const match = block.trim().match(/^(\d+)::([\s\S]*)/);
                  if (match)
                    translatedMap.set(
                      parseInt(match[1], 10) - 1,
                      match[2].trim()
                    );
                });
                if (translatedMap.size === chunk.length) {
                  isValidResponse = true;
                } else {
                  console.warn(
                    `Attempt ${attempt}: Invalid response for chunk ${chunkIndex}. Expected ${chunk.length}, got ${translatedMap.size}. Retrying...`
                  );
                  if (attempt >= MAX_ATTEMPTS)
                    throw new Error(
                      `API trả về phản hồi không hợp lệ cho khối ${chunkIndex} sau ${MAX_ATTEMPTS} lần thử.`
                    );
                  await new Promise((res) => setTimeout(res, 1000 * attempt));
                }
              } catch (error) {
                if (attempt >= MAX_ATTEMPTS) throw error;
                console.warn(
                  `Attempt ${attempt}: API call failed for chunk ${chunkIndex}. Retrying...`,
                  error
                );
                await new Promise((res) => setTimeout(res, 1000 * attempt));
              }
            }

            const tempTranslatedChunk = [];
            const translatedMap = new Map();
            translatedText.split("\n---\n").forEach((block) => {
              const match = block.trim().match(/^(\d+)::([\s\S]*)/);
              if (match)
                translatedMap.set(parseInt(match[1], 10) - 1, match[2].trim());
            });
            chunk.forEach((sub, index) => {
              const newSub = { ...sub };
              newSub.text = translatedMap.has(index)
                ? translatedMap.get(index)
                : `[LỖI DỊCH] ${sub.text}`;
              translatedParsedSubs.push(newSub);
              tempTranslatedChunk.push(newSub);
            });

            previousChunkContext =
              `BỐI CẢNH TỪ NHỮNG CÂU THOẠI TRƯỚC ĐÓ (để dịch cho khớp):\n` +
              tempTranslatedChunk
                .slice(-3)
                .map((s) => s.text)
                .join("\n");
            displaySubtitles(translatedParsedSubs, translatedSubDiv, true);
            await new Promise((res) => setTimeout(res, 1000));
          }
          translatedSrtContent = buildSRT(translatedParsedSubs);
          statusDiv.textContent =
            "Dịch hoàn tất! Bạn có thể chỉnh sửa trực tiếp bên trên.";
          statusDiv.className = "text-green-500";
          resultContainer.classList.remove("hidden");
          editToolbar.classList.remove("hidden");
          downloadBtnWrapper.classList.remove("hidden"); // Hiển thị nút tải
        } catch (error) {
          console.error("Lỗi dịch:", error);
          statusDiv.textContent = `Đã xảy ra lỗi: ${error.message}`;
          statusDiv.className = "text-red-500";
          throw error;
        } finally {
          loadingContainer.classList.add("hidden");
          loadingContainer.classList.remove("flex");
          translateBtn.disabled = false;
        }
      }

      function checkRemainingChinese() {
        document
          .querySelectorAll(".sub-block.warning-highlight")
          .forEach((el) => el.classList.remove("warning-highlight"));
        const chineseRegex = /[\u4e00-\u9fa5]/;
        const findValue = findInput.value.trim();
        untranslatedIndices = [];
        retranslateIssuesBtn.classList.add("hidden");

        if (translatedParsedSubs.length === 0) {
          editToolStatus.textContent = "Chưa có bản dịch để rà soát.";
          editToolStatus.className = "text-sm mt-2 text-center text-yellow-400";
          return;
        }

        let foundCount = 0;
        translatedParsedSubs.forEach((sub, i) => {
          let hasIssue = false;
          // Kiểm tra tiếng Trung
          if (chineseRegex.test(sub.text)) {
            hasIssue = true;
            untranslatedIndices.push(i);
          }
          // Kiểm tra từ khóa tìm kiếm
          if (findValue && sub.text.includes(findValue)) {
            hasIssue = true;
          }

          if (hasIssue) {
            const block = document.getElementById(`translated-sub-block-${i}`);
            if (block) {
              block.classList.add("warning-highlight");
              foundCount++;
            }
          }
        });

        let statusMessage = "";
        if (foundCount > 0) {
          if (findValue) {
            statusMessage += `Tìm thấy ${foundCount} dòng chứa "${findValue}". `;
          }
          if (untranslatedIndices.length > 0) {
            statusMessage += `Phát hiện ${untranslatedIndices.length} dòng có thể còn sót tiếng Trung.`;
            retranslateIssuesBtn.classList.remove("hidden");
          }
          editToolStatus.textContent = `Rà soát hoàn tất. ${statusMessage}`;
          editToolStatus.className = "text-sm mt-2 text-center text-yellow-400";
          const firstIssue = document.querySelector(
            ".sub-block.warning-highlight"
          );
          if (firstIssue)
            firstIssue.scrollIntoView({ behavior: "smooth", block: "center" });
        } else {
          editToolStatus.textContent =
            "Rà soát hoàn tất. Không tìm thấy vấn đề.";
          editToolStatus.className = "text-sm mt-2 text-center text-green-500";
        }
      }

      async function retranslateIssues() {
        if (untranslatedIndices.length === 0) return;

        retranslateIssuesBtn.disabled = true;
        editToolStatus.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Đang dịch lại ${untranslatedIndices.length} dòng lỗi...`;
        editToolStatus.className = "text-sm mt-2 text-center text-blue-400";

        const characterContext = getCharacterContext();
        const selectedGenre = genreSelect.value;
        const plotContextForRetranslation = plotAnalysisContext;
        const relationshipContextForRetranslation = relationshipContext;

        // Xác định API key sẽ sử dụng
        const apiKeyToUse =
          retranslateApiKeyInput.value.trim() || userTranslateApiKey;
        if (!apiKeyToUse) {
          editToolStatus.textContent =
            "Lỗi: Cần API Key (ở Cột 1 hoặc ô này) để dịch lại.";
          editToolStatus.className = "text-sm mt-2 text-center text-red-500";
          retranslateIssuesBtn.disabled = false;
          return;
        }

        let successCount = 0;
        const retranslationPromises = untranslatedIndices.map(async (index) => {
          try {
            const originalText = parsedSubs[index].text;
            const translatedText = await callTranslationAPI(
              `1:: ${originalText}`,
              characterContext,
              selectedGenre,
              "", // No previous context for single line re-translation
              plotContextForRetranslation,
              relationshipContextForRetranslation,
              apiKeyToUse // Truyền API key cụ thể
            );
            const match = translatedText.trim().match(/^1::([\s\S]*)/);
            if (match && match[1]) {
              translatedParsedSubs[index].text = match[1].trim();
              successCount++;
            }
          } catch (error) {
            console.error(`Lỗi khi dịch lại dòng index ${index}:`, error);
          }
        });

        await Promise.all(retranslationPromises);

        displaySubtitles(translatedParsedSubs, translatedSubDiv, true);
        translatedSrtContent = buildSRT(translatedParsedSubs);

        editToolStatus.textContent = `Đã dịch lại thành công ${successCount} / ${untranslatedIndices.length} dòng.`;
        editToolStatus.className = "text-sm mt-2 text-center text-green-500";

        retranslateIssuesBtn.disabled = false;
        retranslateIssuesBtn.classList.add("hidden");
        untranslatedIndices = [];

        // Re-run the check to confirm
        setTimeout(checkRemainingChinese, 500);
      }

      async function callTranslationAPI(
        text,
        characterContext,
        genre,
        previousContext,
        plotAnalysisContext,
        relationshipContext,
        specificApiKey = null // Thêm tham số cho API key cụ thể
      ) {
        // Ưu tiên API key cụ thể (cho việc dịch lại), nếu không có thì dùng key chung
        const apiKey = specificApiKey || userTranslateApiKey;

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${
          apiKey || ""
        }`;
        const genreInstruction =
          genre && genre !== "chung"
            ? `PHONG CÁCH DỊCH: Dịch theo phong cách phù hợp với thể loại '${genre}'.`
            : "";
        // **RULE for "Nhân vật tôi"**
        const narratorRule = `6. XƯNG HÔ "NHÂN VẬT TÔI": Nếu người nói là "Nhân vật tôi" (Người kể chuyện), hãy mặc định dịch đại từ nhân xưng là "tôi", trừ khi bối cảnh (ví dụ: nói chuyện với vua, cha mẹ) rõ ràng yêu cầu cách xưng hô khác (ví dụ: thần, con...).`

        const systemPrompt = `Bạn là chuyên gia dịch thuật phụ đề từ tiếng Trung sang tiếng Việt. Nhiệm vụ của bạn là dịch với độ chính xác và nhất quán cao nhất dựa trên các bối cảnh được cung cấp.

BỐI CẢNH CỐT TRUYỆN (để hiểu rõ hơn về mạch truyện, chỉ dùng để tham khảo, không được lấy nội dung từ đây để dịch):
${plotAnalysisContext || "Không có."}

${characterContext}

BỐI CẢNH MỐI QUAN HỆ VÀ XƯNG HÔ (Tham khảo kỹ để dịch xưng hô cho đúng):
${relationshipContext || "Chưa phân tích."}

${previousContext}

QUY TẮC TUYỆT ĐỐI:
1. GIỮ NGUYÊN CẤU TRÚC SỐ: Đầu vào có dạng 'số:: nội dung' và phân tách bằng '---'. Đầu ra BẮT BUỘC phải giữ nguyên format 'số:: nội dung đã dịch' và dấu '---'.
2. KHÔNG BÌNH LUẬN: Chỉ trả về nội dung dịch.
3. TUÂN THỦ "QUY TẮC DỊCH TÊN/XƯNG HÔ CHÍNH" ở trên.
4. CHỦ ĐỘNG SỬ DỤNG Giới tính, Tuổi (từ Bối cảnh nhân vật) và Bối cảnh mối quan hệ để quyết định cách xưng hô (anh, em, chị, ông, bà...) cho phù hợp văn hóa Việt Nam.
5. ${genreInstruction}
${narratorRule}`; // Added the new rule here

        const payload = {
          contents: [{ parts: [{ text: text }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: { temperature: 0.3, topK: 1, topP: 1 },
          safetySettings: [
            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
            {
              category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
              threshold: "BLOCK_NONE",
            },
            {
              category: "HARM_CATEGORY_DANGEROUS_CONTENT",
              threshold: "BLOCK_NONE",
            },
          ],
        };
        let retries = 3,
          delay = 1000,
          response;
        while (retries > 0) {
          try {
            response = await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            if (response.ok) {
              const result = await response.json();
              const candidate = result.candidates?.[0];
              if (candidate && candidate.content?.parts?.[0]?.text)
                return candidate.content.parts[0].text;
              if (result.promptFeedback?.blockReason)
                throw new Error(
                  `Nội dung bị chặn bởi bộ lọc an toàn: ${result.promptFeedback.blockReason}`
                );
              throw new Error(
                `Phản hồi API không hợp lệ: ${JSON.stringify(result)}`
              );
            }
            if (response.status === 429 || response.status === 503)
              throw new Error("Rate limited");
            throw new Error(
              `Lỗi HTTP: ${response.status} ${await response.text()}`
            );
          } catch (error) {
            if (
              error.message.includes("Rate limited") ||
              error.message.includes("Nội dung bị chặn")
            ) {
              retries--;
              if (retries === 0)
                throw new Error(
                  "API quá tải hoặc nội dung bị chặn. Vui lòng thử lại sau."
                );
              await new Promise((res) => setTimeout(res, delay));
              delay *= 2;
            } else throw error;
          }
        }
        throw new Error("Không thể dịch sau nhiều lần thử.");
      }

      // --- Download Logic ---
      function downloadSRT() {
        translatedSrtContent = buildSRT(translatedParsedSubs);
        if (!translatedSrtContent) return;
        const blob = new Blob([translatedSrtContent], {
          type: "text/plain;charset=utf-8",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${originalFileName}_vi.srt`;
        a.click();
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>