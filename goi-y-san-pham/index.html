<!DOCTYPE html>
<html lang="vi" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tr·ª£ l√Ω Affiliate Shopee v·ªõi Gemini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Th∆∞ vi·ªán mammoth.js ƒë·ªÉ ƒë·ªçc file .docx -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <!-- Th∆∞ vi·ªán marked.js ƒë·ªÉ hi·ªÉn th·ªã markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap");
      body {
        font-family: "Be Vietnam Pro", sans-serif;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #2d3748;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #4a5568;
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #718096;
      }
      #api-key-drawer {
        transition: transform 0.3s ease-in-out;
      }
      .spinner {
        border-top-color: #3498db;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      /* C·∫£i thi·ªán hi·ªÉn th·ªã markdown */
      .prose h3 {
        margin-top: 1.5em;
        margin-bottom: 0.5em;
      }
      .prose p,
      .prose ul {
        margin-top: 0.5em;
        margin-bottom: 0.5em;
      }
    </style>
  </head>
  <body
    class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 antialiased"
  >
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
      <!-- Header -->
      <header class="flex justify-between items-center mb-6">
        <h1
          class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white"
        >
          Tr·ª£ l√Ω Affiliate Shopee
        </h1>
        <button
          id="settings-btn"
          class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
        >
          <i data-lucide="settings" class="w-6 h-6"></i>
        </button>
      </header>

      <!-- API Key Drawer -->
      <div
        id="api-key-drawer"
        class="fixed top-0 right-0 h-full w-full sm:w-96 bg-white dark:bg-gray-800 shadow-xl z-50 p-6 transform translate-x-full"
      >
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-semibold">C√†i ƒë·∫∑t API Key</h2>
          <button
            id="close-drawer-btn"
            class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"
          >
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
          Nh·∫≠p m·ªôt ho·∫∑c nhi·ªÅu API Key c·ªßa Gemini, m·ªói key m·ªôt d√≤ng. H·ªá th·ªëng s·∫Ω
          t·ª± ƒë·ªông chuy·ªÉn ƒë·ªïi n·∫øu c√≥ l·ªói. L·∫•y API Key c·ªßa b·∫°n t·∫°i
          <a
            href="https://aistudio.google.com/api-keys"
            target="_blank"
            class="text-blue-500 hover:underline"
            >aistudio.google.com</a
          >.
        </p>
        <textarea
          id="api-keys-input"
          class="w-full h-40 p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors custom-scrollbar"
          placeholder="d√°n API key v√†o ƒë√¢y..."
        ></textarea>
        <div class="flex gap-4 mt-4">
          <button
            id="save-keys-btn"
            class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-all transform hover:scale-105"
          >
            L∆∞u
          </button>
          <button
            id="clear-keys-btn"
            class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition-all transform hover:scale-105"
          >
            X√≥a
          </button>
        </div>
        <p id="api-status" class="text-sm mt-4 text-center"></p>
      </div>
      <div
        id="drawer-overlay"
        class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"
      ></div>

      <main class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 sm:p-8">
        <!-- Input Section -->
        <div class="mb-6">
          <h2 class="text-xl font-semibold mb-3">N·ªôi dung truy·ªán</h2>
          <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
            <textarea
              id="story-content"
              class="w-full h-48 p-3 bg-transparent border-0 rounded-lg focus:ring-0 custom-scrollbar"
              placeholder="D√°n n·ªôi dung truy·ªán c·ªßa b·∫°n v√†o ƒë√¢y..."
            ></textarea>
            <div class="flex items-center justify-between mt-2">
              <label
                for="docx-upload"
                class="cursor-pointer inline-flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-600 text-sm font-medium rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors"
              >
                <i data-lucide="file-up" class="w-4 h-4 mr-2"></i>
                T·∫£i l√™n file .docx
              </label>
              <input
                type="file"
                id="docx-upload"
                class="hidden"
                accept=".docx"
              />
              <span
                id="file-name"
                class="text-sm text-gray-500 dark:text-gray-400"
              ></span>
            </div>
          </div>
        </div>

        <!-- Action Button -->
        <div class="text-center">
          <button
            id="analyze-btn"
            class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-8 py-3 rounded-lg font-bold text-lg hover:from-purple-700 hover:to-blue-700 transition-all transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span id="btn-text">Ph√¢n t√≠ch</span>
            <div
              id="btn-spinner"
              class="spinner w-6 h-6 rounded-full border-4 border-t-4 border-gray-200 hidden mx-auto"
            ></div>
          </button>
        </div>

        <!-- Output Section -->
        <div id="output-section" class="mt-8 hidden">
          <h2
            class="text-xl font-semibold mb-4 border-b pb-2 border-gray-200 dark:border-gray-700"
          >
            G·ª£i √Ω s·∫£n ph·∫©m Affiliate
          </h2>
          <div
            id="analysis-result"
            class="prose prose-sm sm:prose-base dark:prose-invert max-w-none prose-p:my-2 prose-li:my-1 prose-h3:mt-4 prose-h3:mb-2"
          >
            <!-- K·∫øt qu·∫£ t·ª´ Gemini s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
          </div>
        </div>
      </main>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        lucide.createIcons();

        const settingsBtn = document.getElementById("settings-btn");
        const closeDrawerBtn = document.getElementById("close-drawer-btn");
        const apiKeyDrawer = document.getElementById("api-key-drawer");
        const drawerOverlay = document.getElementById("drawer-overlay");
        const apiKeysInput = document.getElementById("api-keys-input");
        const saveKeysBtn = document.getElementById("save-keys-btn");
        const clearKeysBtn = document.getElementById("clear-keys-btn");
        const apiStatus = document.getElementById("api-status");

        const storyContent = document.getElementById("story-content");
        const docxUpload = document.getElementById("docx-upload");
        const fileNameSpan = document.getElementById("file-name");
        const analyzeBtn = document.getElementById("analyze-btn");
        const btnText = document.getElementById("btn-text");
        const btnSpinner = document.getElementById("btn-spinner");
        const outputSection = document.getElementById("output-section");
        const analysisResult = document.getElementById("analysis-result");

        let apiKeys = [];
        let currentKeyIndex = 0;

        // --- API Key Management ---

        const loadApiKeys = () => {
          const storedKeys = localStorage.getItem("geminiApiKeys");
          if (storedKeys) {
            apiKeys = storedKeys.split("\n").filter((key) => key.trim() !== "");
            apiKeysInput.value = storedKeys;
          }
          updateApiStatus();
        };

        const saveApiKeys = () => {
          const keys = apiKeysInput.value;
          localStorage.setItem("geminiApiKeys", keys);
          apiKeys = keys.split("\n").filter((key) => key.trim() !== "");
          currentKeyIndex = 0;
          updateApiStatus();
          toggleDrawer(false);
        };

        const clearApiKeys = () => {
          localStorage.removeItem("geminiApiKeys");
          apiKeysInput.value = "";
          apiKeys = [];
          updateApiStatus();
          toggleDrawer(false);
        };

        const updateApiStatus = () => {
          if (apiKeys.length > 0) {
            apiStatus.textContent = `ƒê√£ l∆∞u ${apiKeys.length} API Key.`;
            apiStatus.className = "text-sm mt-4 text-center text-green-500";
            analyzeBtn.disabled = false;
          } else {
            apiStatus.textContent =
              "Ch∆∞a c√≥ API Key. Vui l√≤ng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng.";
            apiStatus.className = "text-sm mt-4 text-center text-red-500";
            analyzeBtn.disabled = true;
          }
        };

        const getNextApiKey = () => {
          if (apiKeys.length === 0) return null;
          const key = apiKeys[currentKeyIndex];
          currentKeyIndex = (currentKeyIndex + 1) % apiKeys.length;
          return key;
        };

        // --- Drawer UI ---

        const toggleDrawer = (show) => {
          if (show) {
            apiKeyDrawer.classList.remove("translate-x-full");
            drawerOverlay.classList.remove("hidden");
          } else {
            apiKeyDrawer.classList.add("translate-x-full");
            drawerOverlay.classList.add("hidden");
          }
        };

        settingsBtn.addEventListener("click", () => toggleDrawer(true));
        closeDrawerBtn.addEventListener("click", () => toggleDrawer(false));
        drawerOverlay.addEventListener("click", () => toggleDrawer(false));
        saveKeysBtn.addEventListener("click", saveApiKeys);
        clearKeysBtn.addEventListener("click", clearApiKeys);

        // --- File Handling ---

        docxUpload.addEventListener("change", (event) => {
          const file = event.target.files[0];
          if (!file) return;

          fileNameSpan.textContent = `ƒêang t·∫£i: ${file.name}`;
          const reader = new FileReader();
          reader.onload = function (e) {
            mammoth
              .extractRawText({ arrayBuffer: e.target.result })
              .then((result) => {
                storyContent.value = result.value;
                fileNameSpan.textContent = `ƒê√£ t·∫£i: ${file.name}`;
              })
              .catch((err) => {
                console.error("L·ªói ƒë·ªçc file docx:", err);
                fileNameSpan.textContent = "L·ªói khi ƒë·ªçc file.";
              });
          };
          reader.readAsArrayBuffer(file);
        });

        // --- Core Logic: Gemini API Call ---

        const analyzeContent = async () => {
          const content = storyContent.value.trim();
          if (!content) {
            displayError("Vui l√≤ng nh·∫≠p n·ªôi dung truy·ªán ƒë·ªÉ ph√¢n t√≠ch.");
            return;
          }
          if (apiKeys.length === 0) {
            displayError("Vui l√≤ng nh·∫≠p API Key trong ph·∫ßn c√†i ƒë·∫∑t.");
            toggleDrawer(true);
            return;
          }

          setLoading(true);
          outputSection.classList.add("hidden");

          const systemPrompt = `B·∫°n l√† m·ªôt tr·ª£ l√Ω marketing affiliate th√¥ng minh, chi ti·∫øt v√† **ƒë·∫∑c bi·ªát c·∫©n tr·ªçng v·ªÅ an to√†n s·∫£n ph·∫©m**. Nhi·ªám v·ª• c·ªßa b·∫°n l√† ƒë·ªçc k·ªπ m·ªôt ƒëo·∫°n vƒÉn b·∫£n v√† x√°c ƒë·ªãnh c√°c ƒë·ªì v·∫≠t v·∫≠t l√Ω ƒë∆∞·ª£c ƒë·ªÅ c·∫≠p.

**QUY T·∫ÆC AN TO√ÄN QUAN TR·ªåNG NH·∫§T:**
* **TUY·ªÜT ƒê·ªêI KH√îNG g·ª£i √Ω** c√°c s·∫£n ph·∫©m c√≥ nguy c∆° ·∫£nh h∆∞·ªüng ƒë·∫øn s·ª©c kh·ªèe n·∫øu ch·∫•t l∆∞·ª£ng k√©m. C·ª• th·ªÉ l√†:
    * Th·ª±c ph·∫©m, ƒë·ªì ƒÉn, ƒë·ªì u·ªëng.
    * Thu·ªëc, th·ª±c ph·∫©m ch·ª©c nƒÉng, vitamin.
    * M·ªπ ph·∫©m, kem d∆∞·ª°ng da, son m√¥i, ho·∫∑c b·∫•t c·ª© th·ª© g√¨ b√¥i tr·ª±c ti·∫øp l√™n c∆° th·ªÉ.
* **CH·ªà G·ª¢I √ù** nh·ªØng s·∫£n ph·∫©m an to√†n nh∆∞: ƒë·ªì gia d·ª•ng, ƒë·ªì trang tr√≠, qu·∫ßn √°o, ph·ª• ki·ªán, s√°ch, ƒë·ªì ƒëi·ªán t·ª≠... nh·ªØng th·ª© m√† n·∫øu c√≥ b·ªã l·ªói c≈©ng kh√¥ng g√¢y h·∫°i cho s·ª©c kh·ªèe ng∆∞·ªùi d√πng.

V·ªõi M·ªñI s·∫£n ph·∫©m an to√†n b·∫°n t√¨m th·∫•y, h√£y th·ª±c hi·ªán c√°c b∆∞·ªõc sau:
1.  **Tr√≠ch d·∫´n:** L·∫•y ra c√¢u vƒÉn ho·∫∑c ƒëo·∫°n vƒÉn ng·∫Øn c√≥ ch·ª©a t√™n ƒë·ªì v·∫≠t ƒë√≥ t·ª´ n·ªôi dung g·ªëc.
2.  **X√°c ƒë·ªãnh t·ª´ kh√≥a:** R√∫t ra t·ª´ kh√≥a t√¨m ki·∫øm ch√≠nh x√°c v√† hi·ªáu qu·∫£ nh·∫•t cho s·∫£n ph·∫©m ƒë√≥.
3.  **T·∫°o link Shopee:** T·∫°o link t√¨m ki·∫øm tr√™n Shopee Vi·ªát Nam, **s·∫Øp x·∫øp theo "B√°n ch·∫°y nh·∫•t"**. ƒê·ªãnh d·∫°ng: \`https://shopee.vn/search?keyword=t·ª´+kh√≥a+ƒë√£+m√£+h√≥a&sortBy=sales\`.
4.  **ƒê∆∞a ra l·ªùi khuy√™n:** Nh·∫Øc nh·ªü ng∆∞·ªùi d√πng ki·ªÉm tra k·ªπ l∆∞·ª£t b√°n v√† ƒë√°nh gi√° (4-5 sao) tr∆∞·ªõc khi ch·ªçn s·∫£n ph·∫©m.

H√£y tr·∫£ v·ªÅ k·∫øt qu·∫£ d∆∞·ªõi d·∫°ng markdown, ƒë∆∞·ª£c c·∫•u tr√∫c r√µ r√†ng cho t·ª´ng s·∫£n ph·∫©m.

V√≠ d·ª•, n·∫øu n·ªôi dung l√† "C√¥ g√°i ng·ªìi b√™n b√†n g·ªó, ƒë·ªçc cu·ªën s√°ch c≈©.", b·∫°n ph·∫£i ph√¢n t√≠ch nh∆∞ sau:

### ü™ë B√†n g·ªó
* **Tr√≠ch d·∫´n t·ª´ n·ªôi dung:** "C√¥ g√°i ng·ªìi b√™n b√†n g·ªó..."
* **T·ª´ kh√≥a t√¨m ki·∫øm:** b√†n g·ªó, b√†n l√†m vi·ªác g·ªó
* **Link Shopee (B√°n ch·∫°y):** [T√¨m 'b√†n g·ªó' tr√™n Shopee](https://shopee.vn/search?keyword=b%C3%A0n%20g%E1%BB%97&sortBy=sales)
* **L∆∞u √Ω:** H√£y ki·ªÉm tra v√† ∆∞u ti√™n s·∫£n ph·∫©m c√≥ ƒë√°nh gi√° t·ªët v√† nhi·ªÅu l∆∞·ª£t mua.

### üìñ Cu·ªën s√°ch c≈©
* **Tr√≠ch d·∫´n t·ª´ n·ªôi dung:** "...ƒë·ªçc cu·ªën s√°ch c≈©."
* **T·ª´ kh√≥a t√¨m ki·∫øm:** s√°ch c≈©, s√°ch vƒÉn h·ªçc c≈©
* **Link Shopee (B√°n ch·∫°y):** [T√¨m 's√°ch c≈©' tr√™n Shopee](https://shopee.vn/search?keyword=s%C3%A1ch%20c%C5%A9&sortBy=sales)
* **L∆∞u √Ω:** H√£y ki·ªÉm tra v√† ∆∞u ti√™n s·∫£n ph·∫©m c√≥ ƒë√°nh gi√° t·ªët v√† nhi·ªÅu l∆∞·ª£t mua.
`;

          const userPrompt = `D∆∞·ªõi ƒë√¢y l√† n·ªôi dung truy·ªán, h√£y ph√¢n t√≠ch v√† ƒë∆∞a ra g·ª£i √Ω s·∫£n ph·∫©m:\n\n---\n\n${content}`;

          let success = false;
          const totalKeys = apiKeys.length;

          for (let i = 0; i < totalKeys; i++) {
            const apiKey = getNextApiKey();
            if (!apiKey) continue;

            try {
              const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                      temperature: 0.4,
                      maxOutputTokens: 2048,
                    },
                  }),
                }
              );

              if (response.ok) {
                const result = await response.json();
                const generatedText =
                  result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (generatedText) {
                  displayResult(generatedText);
                  success = true;
                  break;
                }
              }
              console.log(
                `API Key ${
                  i + 1
                } kh√¥ng ho·∫°t ƒë·ªông ho·∫∑c ƒë√£ h·∫øt h·∫°n, ƒëang th·ª≠ key ti·∫øp theo...`
              );
            } catch (error) {
              console.error(`L·ªói khi g·ªçi API v·ªõi key ${i + 1}:`, error);
            }
          }

          if (!success) {
            displayError(
              "T·∫•t c·∫£ API Key ƒë·ªÅu kh√¥ng ho·∫°t ƒë·ªông ho·∫∑c ƒë√£ x·∫£y ra l·ªói. Vui l√≤ng ki·ªÉm tra l·∫°i API Key trong ph·∫ßn c√†i ƒë·∫∑t."
            );
          }

          setLoading(false);
        };

        const addCopyButtons = () => {
          const links = analysisResult.querySelectorAll("a");
          links.forEach((link) => {
            const copyBtn = document.createElement("button");
            copyBtn.innerHTML = `<i data-lucide="copy" class="w-4 h-4 inline-block -mt-1"></i>`;
            copyBtn.title = "Sao ch√©p link";
            copyBtn.className =
              "ml-2 text-xs bg-gray-200 dark:bg-gray-600 p-1 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors inline-flex items-center justify-center";

            copyBtn.onclick = (e) => {
              e.preventDefault();
              const textToCopy = link.href;

              const textArea = document.createElement("textarea");
              textArea.value = textToCopy;
              textArea.style.position = "fixed";
              textArea.style.top = "-9999px";
              textArea.style.left = "-9999px";
              document.body.appendChild(textArea);
              textArea.focus();
              textArea.select();

              try {
                document.execCommand("copy");
                copyBtn.innerHTML = `<i data-lucide="check" class="w-4 h-4 text-green-500"></i>`;
              } catch (err) {
                console.error("Kh√¥ng th·ªÉ sao ch√©p link:", err);
                copyBtn.innerHTML = `<i data-lucide="x" class="w-4 h-4 text-red-500"></i>`;
              }

              document.body.removeChild(textArea);

              setTimeout(() => {
                copyBtn.innerHTML = `<i data-lucide="copy" class="w-4 h-4"></i>`;
                lucide.createIcons();
              }, 2000);
            };

            link.insertAdjacentElement("afterend", copyBtn);
          });
          lucide.createIcons();
        };

        const displayResult = (markdownText) => {
          analysisResult.innerHTML = marked.parse(markdownText, {
            gfm: true,
            breaks: true,
          });
          outputSection.classList.remove("hidden");
          addCopyButtons();
        };

        const displayError = (errorMessage) => {
          analysisResult.innerHTML = `<p class="text-red-500 font-medium">${errorMessage}</p>`;
          outputSection.classList.remove("hidden");
        };

        const setLoading = (isLoading) => {
          if (isLoading) {
            analyzeBtn.disabled = true;
            btnText.classList.add("hidden");
            btnSpinner.classList.remove("hidden");
          } else {
            analyzeBtn.disabled = false;
            btnText.classList.remove("hidden");
            btnSpinner.classList.add("hidden");
          }
        };

        analyzeBtn.addEventListener("click", analyzeContent);

        // --- Initialization ---
        loadApiKeys();
      });
    </script>
  </body>
</html>
